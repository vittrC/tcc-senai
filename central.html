<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VAULT CENTER - Central de usu√°rios</title>
  <link rel="stylesheet" href="css/stylecentral.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <style>
    /* Ajustes espec√≠ficos da p√°gina para alinhamento */
    .grid-layout { max-width:1200px; margin:20px auto; padding:16px; display:grid; grid-template-columns:300px 1fr 320px; gap:18px; align-items:start; }
    .hidden { display:none !important; }
    /* modal central */
    #profileModal .modal-card { background:linear-gradient(180deg,#041817,#062d2a); padding:18px; border-radius:10px; color:inherit; }
    /* override avatar selector fixed -> keep near profile card */
    #perfil-icone { position:relative; }
    #selecao-avatar { position:relative; top:0; right:0; display:flex; flex-wrap:wrap; gap:6px; justify-content:center; padding-top:8px; }
    /* alinhamento do feed */
    .post .post-top .meta { align-items:center; }
    .post .post-actions { justify-content:flex-end; }
    /* make follow buttons consistent */
    .followBtn { min-width:90px; }
    @media (max-width:1000px){ .grid-layout { grid-template-columns:1fr; } .xp-bar{width:100%} }
  </style>
</head>
<body>
  <div class="grid-layout">

    <!-- Perfil / Sidebar -->
    <div class="card profile-card">
      <div id="perfil-icone" onclick="mostrarOpcoesAvatar()">
        <img id="avatar-img" src="img/img1.png" alt="Avatar" />
      </div>

      <h2 id="profile-name">Usu√°rio</h2>
      <div class="level-badge" id="profile-level">N√≠vel 1</div>

      <div class="xp-bar" title="Progresso para pr√≥ximo n√≠vel">
        <div class="xp-fill" id="xp-fill" style="width:0%"></div>
      </div>
      <div style="margin-top:8px; font-size:13px;" id="xp-text">0 XP ‚Ä¢ 0/100</div>

      <div class="streak" id="profile-streak">üî• Streak: 0 dias</div>

      <div class="badges" id="profile-badges">
        <!-- Badges din√¢micas -->
      </div>

      <div style="margin-top:12px; display:flex; gap:8px;">
        <button class="btn" id="edit-profile-btn">Editar</button>
        <button class="btn btn-ghost" id="logout-btn">Sair</button>
      </div>

      <hr style="margin:12px 0; border-color:rgba(255,255,255,0.03)">

      <!-- Seletor de avatar: 12 imagens -->
      <div id="selecao-avatar" style="margin-top:10px; display:none; width:100%;">
        <div class="avatar-grid">
          <img src="img/img1.png" class="avatar" onclick="selecionarAvatar('img/img1.png')" alt="a1">
          <img src="img/img2.png" class="avatar" onclick="selecionarAvatar('img/img2.png')" alt="a2">
          <img src="img/img3.png" class="avatar" onclick="selecionarAvatar('img/img3.png')" alt="a3">
          <img src="img/img4.png" class="avatar" onclick="selecionarAvatar('img/img4.png')" alt="a4">
          <img src="img/img5.png" class="avatar" onclick="selecionarAvatar('img/img5.png')" alt="a5">
          <img src="img/img6.png" class="avatar" onclick="selecionarAvatar('img/img6.png')" alt="a6">
          <img src="img/img7.png" class="avatar" onclick="selecionarAvatar('img/img7.png')" alt="a7">
          <img src="img/img8.png" class="avatar" onclick="selecionarAvatar('img/img8.png')" alt="a8">
          <img src="img/img9.png" class="avatar" onclick="selecionarAvatar('img/img9.png')" alt="a9">
          <img src="img/img10.png" class="avatar" onclick="selecionarAvatar('img/img10.png')" alt="a10">
          <img src="img/img11.png" class="avatar" onclick="selecionarAvatar('img/img11.png')" alt="a11">
          <img src="img/img12.png" class="avatar" onclick="selecionarAvatar('img/img12.png')" alt="a12">
        </div>
      </div>
    </div>

    <!-- Feed / Conte√∫do central -->
    <div>
      <section class="hero">
        <h1 style="margin:6px 0 4px 0;">VAULT CENTER</h1>
        <p style="margin:0 0 6px 0; color:#9eeed1;">Acompanhe seu progresso, compartilhe conquistas e veja o que outros est√£o aprendendo.</p>
        <div style="text-align:center; margin-top:10px;">
          <button id="gotoCourses" class="btn">Ir para os Cursos</button>
          <button id="openAchievements" class="btn" style="margin-left:10px;">Conquistas</button>
        </div>
      </section>

      <div class="card post-box">
        <div style="display:flex; gap:10px; align-items:flex-start;">
          <img id="post-avatar" src="img/img1.png" alt="me" style="width:48px;height:48px;border-radius:50%;border:2px solid #00ff9c;object-fit:cover">
          <div style="flex:1;">
            <textarea id="post-text" class="post-textarea" placeholder="Compartilhe uma conquista, dica ou d√∫vida..."></textarea>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
              <button class="btn" id="post-btn">Publicar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="feed" id="feed">
        <!-- Posts carregados dinamicamente -->
      </div>

      <!-- Pontua√ß√£o geral (gr√°fico) -->
      <!-- <div class="card" style="margin-top:12px;">
        <h3>Sua Pontua√ß√£o</h3>
        <div style="height:180px;">
          <canvas id="scoreChart"></canvas>
        </div>
      </div> -->
    </div>

    <!-- Right sidebar: leaderboard e amigos -->
    <div>
      <div class="card">
        <h3>Leaderboard</h3>
        <ol id="leaderboard" class="leaderboard" style="margin:0;padding:0;"></ol>
      </div>

      <!-- removido: card duplicado de Pontua√ß√£o dos Cursos (agora mostrado apenas ao final da p√°gina) -->

      <div class="card" style="margin-top:12px;">
        <h3>Amigos / Seguindo</h3>
        <div id="friends-search" style="margin-bottom:10px;">
          <input id="search-user" type="text" placeholder="Buscar usu√°rio..." style="width:100%;padding:6px;border-radius:6px;border:1px solid #00ff9c;background:#041817;color:#00ff9c;">
          <button class="btn" id="search-btn" style="margin-top:6px;width:100%;">Buscar</button>
        </div>

        <!-- Resultados da busca aparecer√£o aqui -->
        <div id="usersList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;"></div>

        <div id="friends" class="friends-list" style="display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;"></div>
        <hr style="margin:8px 0;border-color:rgba(255,255,255,0.03)">
        <h4 style="margin:6px 0 8px 0">Funcion√°rios Recomendados</h4>
        <!-- mostrar poucos perfis recomendados sem scroll -->
        <div id="user-suggestions" style="display:flex;flex-direction:column;gap:8px;max-height:none;overflow:visible"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Atividades Recentes</h3>
        <div id="activity-feed" style="font-size:13px;color:#9eeed1; display:flex;flex-direction:column;gap:6px;"></div>
      </div>

      <!-- removido bloco "Intera√ß√µes Sociais" duplicado (limpeza de UI) -->
    </div>

  </div>

  <!-- Cursos (grid de baixo permanece) -->
  <h2 id="cursos" style="text-align:center;margin-top:24px;color:#00ff9c">Cursos Dispon√≠veis</h2>
  <section class="course-grid">
    <div class="course-card">
      <span class="material-symbols-outlined">volunteer_activism</span>
      <h3 class="course-title">Empatia</h3>
      <p class="course-desc">Aprenda a se colocar no lugar do outro e fortalecer conex√µes no ambiente de trabalho.</p>
      <button class="btn course-btn" data-course="empatia" title="Abrir Empatia">
      Acessar
      </button>
    </div>
    <div class="course-card">
      <span class="material-symbols-outlined">diversity_3</span>
      <h3 class="course-title">Trabalho em Equipe</h3>
      <p class="course-desc">Descubra t√©cnicas para colabora√ß√£o eficiente e alcance metas em conjunto.</p>
      <button class="btn course-btn" data-course="equipe" title="Abrir Trabalho em Equipe">
        Acessar
      </button>
    </div>
    <div class="course-card">
      <span class="material-symbols-outlined">neurology</span>
      <h3 class="course-title">Intelig√™ncia Emocional</h3>
      <p class="course-desc">Domine suas emo√ß√µes e melhore a tomada de decis√µes em situa√ß√µes desafiadoras.</p>
      <button class="btn course-btn" data-course="emocional" title="Abrir Intelig√™ncia Emocional">
        Acessar
      </button>
    </div>
    <div class="course-card">
      <span class="material-symbols-outlined">record_voice_over</span>
      <h3 class="course-title">Comunica√ß√£o</h3>
      <p class="course-desc">Aprimore suas habilidades de comunica√ß√£o para transmitir mensagens claras e eficazes.</p>
      <button class="btn course-btn" data-course="comunicacao" title="Abrir Comunica√ß√£o">
        Acessar
      </button>
    </div>
  </section>

  <!-- Modal de Conquistas (fix: garante que bot√£o "Conquistas" funcione) -->
  <div id="achievementsModal" class="hidden">
    <div class="ach-card">
      <button class="btn-exit" style="background:transparent;  border:2px solid var(--neon); color:var(--neon);  padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; box-shadow:0 6px 20px rgba(0,255,156,0.06);" onclick="document.getElementById('achievementsModal').classList.add('hidden')">‚úï</button>
      <h3>Conquistas</h3>
      <div class="ach-grid"></div>
    </div>
  </div>

  <!-- Tabela de Pontua√ß√£o dos Cursos (fim da p√°gina) -->
  <section id="course-ranking-bottom" style="max-width:1100px;margin:30px auto;">
    <div class="card" style="padding:18px;">
      <h3 style="margin-top:0;color:var(--neon)">Pontua√ß√£o dos Cursos</h3>
      <div id="course-scores-bottom" style="font-size:14px;color:var(--muted)">Carregando...</div>
    </div>
  </section>

  <!-- modal simples de perfil -->
  <div id="profileModal" class="hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:200;">
    <div class="modal-card">
      <button onclick="closeProfileModal()" style="float:right" class="btn-exit">X</button>
      <div style="text-align:center; padding-top:10px;">
        <img id="modalAvatar" src="img/img1.png" style="width:120px;height:120px;border-radius:50%;border:3px solid #00ff9c;"/>
        <h3 id="modalName" style="margin-top:10px;color:#00ff9c"></h3>
        <p id="modalType" style="color:#aaffdf"></p>
        <p id="modalBio" style="color:var(--text-soft)"></p>
        <button id="modalFollowBtn" class="btn" style="margin-top:12px;"></button>
      </div>
    </div>
  </div>

  <script>
/* Consolidated script ‚Äî safe, single-definition, ordered */

// authentication handling: prefer localStorage.usuario, fallback to Firebase Auth (wait a short per√≠odo).
// Evita redirect imediato que impedia Firebase Auth de preencher o usu√°rio quando presente.
async function ensureLoggedInOrRedirect() {
  if (localStorage.getItem("usuario")) return true;
  if (typeof firebase !== 'undefined' && firebase.auth) {
    // espera at√© 1.5s por onAuthStateChanged
    let resolved = false;
    const p = new Promise(resolve => {
      const unsub = firebase.auth().onAuthStateChanged(user => {
        if (user) {
          const name = user.displayName || user.email || user.uid;
          try { localStorage.setItem('usuario', name); } catch(e){}
          resolved = true;
          try { unsub(); } catch(e){}
          return resolve(true);
        }
      });
      setTimeout(() => { if (!resolved) { try { unsub(); } catch(e){} resolve(false); } }, 1500);
    });
    const ok = await p;
    if (ok) return true;
  }
  // fallback redirect to login
  window.location.href = "login.html";
  return false;
}

const firebaseConfig = {
   apiKey: "AIzaSyAVZ-dvyJuGFF4fEHGjS-TrhzBmBslVwNs",
   authDomain: "curso-3-inteligencia-emocional.firebaseapp.com",
   projectId: "curso-3-inteligencia-emocional",
   storageBucket: "curso-3-inteligencia-emocional.appspot.com",
   messagingSenderId: "105031303963",
   appId: "1:105031303963:web:0ecdcddc91fbb0af69c9be"
 };
 firebase.initializeApp(firebaseConfig);
 const db = firebase.firestore();
 
const nomeUsuario = localStorage.getItem("usuario");
const defaultAvatar = localStorage.getItem('avatar') || 'img/img1.png';

/* ---------- Utilities ---------- */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
function truncate(text, maxLen = 80) {
  if (text === null || text === undefined) return '';
  const s = String(text);
  return s.length > maxLen ? s.slice(0, maxLen - 1) + '‚Ä¶' : s;
}
function calcLevel(xp = 0) {
  const level = Math.floor(xp / 100) + 1;
  const progress = xp % 100;
  return { level, progress, next: 100 };
}
function showToast(text, timeout = 2200) {
  const t = document.createElement('div');
  t.textContent = text;
  t.style.position = 'fixed';
  t.style.right = '18px';
  t.style.bottom = '18px';
  t.style.background = 'linear-gradient(90deg, rgba(0,255,156,0.12), rgba(0,200,140,0.06))';
  t.style.border = '1px solid rgba(0,255,156,0.14)';
  t.style.color = '#00ffd0';
  t.style.padding = '10px 14px';
  t.style.borderRadius = '10px';
  t.style.zIndex = 9999;
  t.style.boxShadow = '0 10px 30px rgba(0,255,156,0.04)';
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity = '0.0', timeout - 300);
  setTimeout(()=> t.remove(), timeout);
}

/* ---------- User doc / profile ---------- */
async function ensureUserDoc() {
  try {
    const q = await db.collection("usuarios").where("nome", "==", nomeUsuario).limit(1).get();
    if (!q.empty) return q.docs[0];
    const newDocRef = await db.collection("usuarios").add({
      nome: nomeUsuario,
      avatar: defaultAvatar,
      xp: 0,
      streak: 0,
      badges: [],
      followers: [],
      following: [],
      followersIds: [],
      followingIds: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return await newDocRef.get();
  } catch (e) {
    console.error("Erro ensureUserDoc:", e);
    return null;
  }
}

/* ---------- Achievements ---------- */
async function revealAchievement(id) {
  try {
    if (!id || !db || !nomeUsuario) return;
    const q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    if (q.empty) return;
    const doc = q.docs[0];
    const data = doc.data() || {};
    const badges = Array.isArray(data.badges) ? data.badges : [];
    if (badges.find(b => b.id === id)) return;
    const badge = { id, title: id, img: `img/${id}.png`, earnedAt: firebase.firestore.FieldValue.serverTimestamp() };
    await doc.ref.update({ badges: firebase.firestore.FieldValue.arrayUnion(badge) });
    try { await addActivity(`${nomeUsuario} desbloqueou: ${id}`); } catch(e){}
    try { showToast(`Conquista desbloqueada: ${id}`); } catch(e){}
    if (typeof renderAchievements === 'function') renderAchievements();
  } catch (e) {
    console.error('revealAchievement error', e);
  }
}

async function renderAchievements() {
  try {
    const modal = document.getElementById('achievementsModal');
    if (!modal) return;
    const grid = modal.querySelector('.ach-grid');
    if (!grid) return;
    grid.innerHTML = 'Carregando...';

    const FALLBACK = {
      ach_post: { id: 'ach_post', title: 'Primeiro Post', hint: 'Publicou no feed.', img: 'img/ach_post.png' },
      ach_like: { id: 'ach_like', title: 'Curtiu', hint: 'Curtiu um post.', img: 'img/ach_like.png' },
      ach_comment: { id: 'ach_comment', title: 'Comentou', hint: 'Comentou em um post.', img: 'img/ach_comment.png' }
    };
    const LIST = (typeof ACH_LIST === 'object' && ACH_LIST) ? ACH_LIST : FALLBACK;

    function parseTimestamp(raw) {
      if (!raw) return null;
      if (raw && typeof raw.toDate === 'function') return raw.toDate();
      if (raw && typeof raw.seconds === 'number') return new Date(raw.seconds * 1000);
      if (typeof raw === 'string') { const d = new Date(raw); if (!isNaN(d)) return d; }
      if (typeof raw === 'number') return new Date(raw);
      return null;
    }

    const q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const data = q.empty ? {} : q.docs[0].data();
    const badges = Array.isArray(data.badges) ? data.badges : [];

    grid.innerHTML = '';
    Object.values(LIST).forEach(meta => {
      const a = meta || {};
      const unlocked = badges.find(b => String(b.id || b.name || b.title) === String(a.id));
      const card = document.createElement('div');
      card.className = 'ach-item-card';
      card.style.display = 'inline-block';
      card.style.width = '160px';
      card.style.margin = '8px';
      card.style.textAlign = 'center';
      card.style.padding = '10px';
      card.style.borderRadius = '10px';
      card.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.08), rgba(0,0,0,0.02))';
      const imgSrc = a.img || 'img/ach_placeholder.png';

      let dateStr = '<span class="muted">' + (a.hint || '') + '</span>';
      if (unlocked) {
        const raw = unlocked.earnedAt || unlocked.ts || unlocked.time || unlocked.date || null;
        const d = parseTimestamp(raw);
        dateStr = d ? ('Conquistada: ' + d.toLocaleString()) : 'Conquistada';
      }

      card.innerHTML = `
        <div style="width:96px;height:96px;margin:0 auto 8px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;border:2px solid rgba(0,255,156,0.06);background:rgba(0,0,0,0.06)">
          <img src="${imgSrc}" alt="${escapeHtml(a.title || '')}" style="width:84px;height:84px;object-fit:cover;filter:${unlocked ? 'none' : 'grayscale(100%) brightness(.6)'}" />
        </div>
        <div style="font-weight:700;color:var(--neon)">${escapeHtml(a.title || a.id)}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">${dateStr}</div>
      `;
      grid.appendChild(card);
    });
  } catch (e) {
    console.error('renderAchievements error', e);
    try { const grid = document.querySelector('#achievementsModal .ach-grid'); if (grid) grid.innerHTML = 'Erro ao carregar conquistas'; } catch(e){}
  }
}

/* ---------- Profile Modal (open/close already used by UI) ---------- */
window.openProfileModal = async function(targetName){
  try {
    if (!targetName) return;
    const modal = document.getElementById('profileModal');
    if (!modal) return;
    const nameEl = document.getElementById('modalName');
    const typeEl = document.getElementById('modalType');
    const bioEl  = document.getElementById('modalBio');
    const avatarEl = document.getElementById('modalAvatar');
    const followBtn = document.getElementById('modalFollowBtn');
    nameEl.textContent = '';
    typeEl.textContent = '';
    bioEl.textContent = '';
    avatarEl.src = defaultAvatar;

    const snap = await db.collection('usuarios').where('nome','==',targetName).limit(1).get();
    if (snap.empty) {
      nameEl.textContent = targetName;
      typeEl.textContent = '';
      bioEl.textContent = 'Usu√°rio n√£o encontrado.';
      followBtn.style.display = 'none';
    } else {
      const d = snap.docs[0].data();
      nameEl.textContent = d.nome || targetName;
      typeEl.textContent = d.tipo || '';
      bioEl.textContent = d.bio || d.descricao || '';
      avatarEl.src = d.avatar || defaultAvatar;
      followBtn.style.display = 'inline-block';

      const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
      const meData = meSnap.empty ? {} : meSnap.docs[0].data();
      const isFollowing = Array.isArray(meData.following) ? meData.following.includes(d.nome) : false;
      followBtn.textContent = isFollowing ? 'Seguindo' : 'Seguir';

      followBtn.onclick = async function(){
        try {
          if (followBtn.textContent.trim() === 'Seguindo') {
            await unfollowUser(d.nome, snap.docs[0].id);
            followBtn.textContent = 'Seguir';
          } else {
            await followUser(d.nome, snap.docs[0].id);
            followBtn.textContent = 'Seguindo';
          }
          if (typeof loadUserSuggestions === 'function') await loadUserSuggestions();
          if (typeof loadFriendsList === 'function') await loadFriendsList();
        } catch(e){ console.warn(e); }
      };
    }
    modal.classList.remove('hidden');
  } catch (e) {
    console.error('openProfileModal error', e);
    alert('Erro ao abrir perfil.');
  }
};
window.closeProfileModal = function(){ const modal = document.getElementById('profileModal'); if (modal) modal.classList.add('hidden'); };

/* ---------- Follow / Unfollow ---------- */
async function followUser(targetName, targetId = null) {
  if (!targetName || targetName === nomeUsuario) return;
  try {
    const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const meDoc = meSnap.empty ? null : meSnap.docs[0];
    const targetRef = targetId ? db.collection('usuarios').doc(targetId) : (await db.collection('usuarios').where('nome','==',targetName).limit(1).get()).docs[0]?.ref;
    if (!meDoc || !targetRef) return;
    const meRef = meDoc.ref;

    await db.runTransaction(async tx => {
      const [mSnap, tSnap] = await Promise.all([tx.get(meRef), tx.get(targetRef)]);
      if (!mSnap.exists || !tSnap.exists) return;
      const mData = mSnap.data() || {};
      const tData = tSnap.data() || {};
      if ((mData.following || []).includes(tData.nome) || (mData.followingIds || []).includes(targetRef.id)) return;
      tx.update(meRef, {
        following: firebase.firestore.FieldValue.arrayUnion(tData.nome),
        followingIds: firebase.firestore.FieldValue.arrayUnion(targetRef.id),
        followingCount: firebase.firestore.FieldValue.increment(1)
      });
      tx.update(targetRef, {
        followers: firebase.firestore.FieldValue.arrayUnion(nomeUsuario),
        followersIds: firebase.firestore.FieldValue.arrayUnion(meRef.id),
        followersCount: firebase.firestore.FieldValue.increment(1)
      });
    });

    try { await addActivity(`${nomeUsuario} come√ßou a seguir ${targetName}`); } catch(e){}
    try {
      await db.collection('notifications').add({
        to: targetName,
        from: nomeUsuario,
        type: 'follow',
        text: `${nomeUsuario} come√ßou a seguir voc√™`,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        read: false
      });
    } catch(e){}
    try { if (typeof loadUsersList === 'function') await loadUsersList(); } catch(e){}
    try { if (typeof loadFriendsList === 'function') await loadFriendsList(); } catch(e){}
    try { showToast('Seguindo ' + targetName); } catch(e){}
  } catch (e) {
    console.error('followUser error', e);
  }
}
async function unfollowUser(targetName, targetId = null) {
  if (!targetName || targetName === nomeUsuario) return;
  try {
    const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const meDoc = meSnap.empty ? null : meSnap.docs[0];
    const targetRef = targetId ? db.collection('usuarios').doc(targetId) : (await db.collection('usuarios').where('nome','==',targetName).limit(1).get()).docs[0]?.ref;
    if (!meDoc || !targetRef) return;
    const meRef = meDoc.ref;

    await db.runTransaction(async tx => {
      const [mSnap, tSnap] = await Promise.all([tx.get(meRef), tx.get(targetRef)]);
      if (!mSnap.exists || !tSnap.exists) return;
      const tData = tSnap.data() || {};
      tx.update(meRef, {
        following: firebase.firestore.FieldValue.arrayRemove(tData.nome),
        followingIds: firebase.firestore.FieldValue.arrayRemove(targetRef.id),
        followingCount: firebase.firestore.FieldValue.increment(-1)
      });
      tx.update(targetRef, {
        followers: firebase.firestore.FieldValue.arrayRemove(nomeUsuario),
        followersIds: firebase.firestore.FieldValue.arrayRemove(meRef.id),
        followersCount: firebase.firestore.FieldValue.increment(-1)
      });
    });

    try { await addActivity(`${nomeUsuario} deixou de seguir ${targetName}`); } catch(e){}
    try { if (typeof loadUsersList === 'function') await loadUsersList(); } catch(e){}
    try { if (typeof loadFriendsList === 'function') await loadFriendsList(); } catch(e){}
    try { showToast('Deixou de seguir ' + targetName); } catch(e){}
  } catch (e) {
    console.error('unfollowUser error', e);
  }
}

/* ---------- Users UI: suggestions (limited) and full list (searchable) ---------- */
async function loadUserSuggestions() {
  const suggestionsEl = document.getElementById('user-suggestions');
  if (!suggestionsEl) return;
  suggestionsEl.innerHTML = 'Carregando...';
  try {
    const me = nomeUsuario;
    const snap = await db.collection('usuarios').orderBy('followersCount','desc').limit(20).get();
    const candidates = [];
    snap.forEach(doc => {
      const u = doc.data();
      if (!u || !u.nome) return;
      if (u.nome === me) return;
      candidates.push({ id: doc.id, ...u });
    });
    // show a small number of recommended profiles
    const top = candidates.slice(0,4);
    suggestionsEl.innerHTML = '';
    top.forEach(u => {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.gap = '8px';
      row.style.padding = '6px 8px';
      row.style.border = '1px solid rgba(0,255,156,0.06)';
      row.style.borderRadius = '10px';
      row.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01))';
      row.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px">
          <img src="${u.avatar || defaultAvatar}" style="width:44px;height:44px;border-radius:50%;border:2px solid #00ff9c;object-fit:cover"/>
          <div>
            <div style="font-weight:700;color:#00ff9c">${escapeHtml(u.nome)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(u.tipo || 'perfil recomendado')}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="openProfileModal('${escapeHtml(u.nome)}')">Perfil</button>
          <button class="btn followBtn" data-name="${escapeHtml(u.nome)}" data-id="${u.id}">Seguir</button>
        </div>
      `;
      suggestionsEl.appendChild(row);
    });
    Array.from(suggestionsEl.querySelectorAll('.followBtn')).forEach(b => {
      b.removeEventListener('click', b._handler);
      b._handler = async function(e){
        const name = e.currentTarget.dataset.name;
        const id = e.currentTarget.dataset.id;
        // toggle
        const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        const meData = meSnap.empty ? {} : meSnap.docs[0].data();
        const isFollowing = Array.isArray(meData.following) ? meData.following.includes(name) : false;
        if (isFollowing) await unfollowUser(name, id);
        else await followUser(name, id);
        loadUserSuggestions().catch(()=>{});
        loadFriendsList().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });
  } catch (err) {
    console.error('loadUserSuggestions error', err);
    suggestionsEl.innerHTML = 'Erro ao carregar perfis recomendados.';
  }
}

async function loadUsersList(filter = '') {
  const container = document.getElementById('usersList');
  if (!container) return;
  container.innerHTML = 'Carregando...';
  try {
    const snap = await db.collection('usuarios').orderBy('nome').get();
    const me = nomeUsuario;
    container.innerHTML = '';
    snap.forEach(doc => {
      const u = doc.data();
      if (!u || !u.nome) return;
      if (u.nome === me) return;
      if (filter && !u.nome.toLowerCase().includes(filter.toLowerCase())) return;
      const card = document.createElement('div');
      card.className = 'card';
      card.style.padding = '8px';

      // show follow state correctly based on current user's following list
      card.innerHTML = (function(){
        const nameEsc = escapeHtml(u.nome);
        return `
         <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
           <div style="display:flex;align-items:center;gap:8px">
             <img src="${u.avatar || defaultAvatar}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid #00ff9c">
             <div>
               <div style="font-weight:700;color:#00ff9c">${escapeHtml(u.nome)}</div>
               <div class="muted" style="font-size:12px">${escapeHtml(u.tipo || '')}</div>
             </div>
           </div>
           <div style="display:flex;gap:8px">
             <button class="btn" onclick="openProfileModal('${nameEsc}')">Perfil</button>
             <button class="btn followBtn" data-name="${nameEsc}" data-id="${doc.id}">Seguir</button>
           </div>
         </div>
       `;
      })();
      container.appendChild(card);
    });
    Array.from(container.querySelectorAll('.followBtn')).forEach(b => {
      b.removeEventListener('click', b._handler);
      b._handler = async function(e){
        const name = e.currentTarget.dataset.name;
        const id = e.currentTarget.dataset.id;
        const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        const meData = meSnap.empty ? {} : meSnap.docs[0].data();
        const isFollowing = Array.isArray(meData.following) ? meData.following.includes(name) : false;
        if (isFollowing) await unfollowUser(name, id);
        else await followUser(name, id);
        loadUsersList(filter).catch(()=>{});
        loadUserSuggestions().catch(()=>{});
        loadFriendsList().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });
  } catch (e) {
    console.error('loadUsersList error', e);
    container.innerHTML = 'Erro ao carregar usu√°rios.';
  }
}

/* ---------- Search users (Firestore prefix search) ---------- */

let _searchTimeout = null;

/**
 * Renderiza um card de usu√°rio (reutiliza estilos j√° existentes)
 * retorna o elemento gerado
 */
function renderUserCard(u, docId) {
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.alignItems = 'center';
  row.style.justifyContent = 'space-between';
  row.style.gap = '8px';
  row.style.padding = '6px 8px';
  row.style.border = '1px solid rgba(0,255,156,0.06)';
  row.style.borderRadius = '10px';
  row.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01))';
  row.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px">
      <img src="${escapeHtml(u.avatar || defaultAvatar)}" style="width:44px;height:44px;border-radius:50%;border:2px solid #00ff9c;object-fit:cover"/>
      <div>
        <div style="font-weight:700;color:#00ff9c">${escapeHtml(u.nome)}</div>
        <div class="muted" style="font-size:12px">${escapeHtml(u.tipo || 'perfil')}</div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="openProfileModal('${escapeHtml(u.nome)}')">Perfil</button>
      <button class="btn followBtn" data-name="${escapeHtml(u.nome)}" data-id="${docId}">Seguir</button>
    </div>
  `;
  return row;
}

/**
 * Pesquisa usu√°rios por prefixo (campo 'nome') usando startAt/endAt
 * Exibe resultados em #usersList
 */
async function searchUsers(q = '') {
  const container = document.getElementById('usersList');
  if (!container) return;
  const query = String(q || '').trim();
  if (!query) {
    container.innerHTML = '<div class="small muted">Digite ao menos 1 caractere para buscar. Dica: use parte do nome.</div>';
    return;
  }
  container.innerHTML = 'Buscando...';
  try {
    // Firestore prefix search (ordenar por nome)
    const snap = await db.collection('usuarios')
      .orderBy('nome')
      .startAt(query)
      .endAt(query + '\uf8ff')
      .limit(40)
      .get();

    container.innerHTML = '';
    if (snap.empty) {
      container.innerHTML = '<div class="small muted">Nenhum usu√°rio encontrado.</div>';
      return;
    }
    snap.forEach(doc => {
      const d = doc.data() || {};
      const card = renderUserCard(d, doc.id);
      container.appendChild(card);
    });

    // wiring follow buttons in results
    Array.from(container.querySelectorAll('.followBtn')).forEach(b => {
      b.removeEventListener('click', b._handler);
      b._handler = async function(e){
        const name = e.currentTarget.dataset.name;
        const id = e.currentTarget.dataset.id;
        const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        const meData = meSnap.empty ? {} : meSnap.docs[0].data();
        const isFollowing = Array.isArray(meData.following) ? meData.following.includes(name) : false;
        if (isFollowing) await unfollowUser(name, id);
        else await followUser(name, id);
        // update UI
        searchUsers(document.getElementById('search-user').value.trim()).catch(()=>{});
        loadFriendsList().catch(()=>{});
        loadUserSuggestions().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });

  } catch (err) {
    console.error('searchUsers error', err);
    container.innerHTML = '<div class="small muted">Erro ao pesquisar usu√°rios.</div>';
  }
}

// debounce wiring
const searchInputEl = document.getElementById('search-user');
const searchBtn = document.getElementById('search-btn');
if (searchInputEl) {
  searchInputEl.addEventListener('input', (e) => {
    clearTimeout(_searchTimeout);
    _searchTimeout = setTimeout(() => {
      searchUsers(e.target.value);
    }, 250);
  });
}
if (searchBtn) {
  searchBtn.addEventListener('click', () => {
    const v = (document.getElementById('search-user') || {}).value || '';
    searchUsers(v);
    // scroll to results
    const el = document.getElementById('usersList');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });
}

// fallback: when page loads, show small hint in usersList and populate recommendations
document.addEventListener('DOMContentLoaded', () => {
  const ul = document.getElementById('usersList');
  if (ul) ul.innerHTML = '<div class="muted small">Busque por nomes de usu√°rios. Resultados aparecem aqui.</div>';
});

/* ---------- Feed, posts, comments, likes (restoration) ---------- */

// realtime subscriptions
let _postsUnsub = null;
let _commentUnsubs = {}; // map postId -> unsubscribe fn

// start watching posts collection and trigger loadFeed on changes
function watchPostsRealtime() {
  try {
    if (!db) return;
    if (_postsUnsub) { try { _postsUnsub(); } catch(e){} _postsUnsub = null; }
    _postsUnsub = db.collection('posts').orderBy('createdAt','desc').limit(100)
      .onSnapshot(() => {
        if (typeof loadFeed === 'function') loadFeed().catch(()=>{});
      }, err => console.warn('posts onSnapshot error', err));
  } catch (e) { console.warn('watchPostsRealtime error', e); }
}

// load feed (renders posts, like/comment/share UI)
async function loadFeed() {
  try {
    const feedEl = document.getElementById('feed');
    if (!feedEl) return;
    feedEl.innerHTML = '<div style="opacity:.6">Carregando...</div>';
    if (!db) { feedEl.innerHTML = '<div class="muted">Offline</div>'; return; }
    const snapshot = await db.collection('posts').orderBy('createdAt','desc').limit(100).get();
    feedEl.innerHTML = '';
    const cutoff = Date.now() - (24 * 60 * 60 * 1000); // optional auto-delete older than 24h (keeps consistent with prior behavior)
    for (const doc of snapshot.docs) {
      const p = doc.data() || {};
      // if createdAt is present and old, skip (do not render)
      if (p.createdAt && typeof p.createdAt.toMillis === 'function') {
        const createdMs = p.createdAt.toMillis();
        if (createdMs < cutoff) { /* do not render older */ continue; }
      }

      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.setAttribute('data-postid', doc.id);
      postEl.style.padding = '12px';
      postEl.style.marginBottom = '10px';
      postEl.style.borderRadius = '10px';
      postEl.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01))';
      // header
      const header = document.createElement('div'); header.className = 'post-top'; header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
      const left = document.createElement('div'); left.className='meta'; left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
      const avatar = document.createElement('img'); avatar.className='post-avatar'; avatar.src = p.avatar || defaultAvatar; avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='50%'; avatar.style.objectFit='cover'; avatar.style.border='1px solid rgba(0,255,156,0.06)';
      const authorWrap = document.createElement('div');
      const nameEl = document.createElement('strong'); nameEl.textContent = p.author || 'Usu√°rio';
      const dateEl = document.createElement('div'); dateEl.className='muted'; dateEl.style.fontSize='12px';
      dateEl.textContent = p.createdAt && typeof p.createdAt.toDate === 'function' ? p.createdAt.toDate().toLocaleString() : '';
      authorWrap.appendChild(nameEl); authorWrap.appendChild(dateEl);
      left.appendChild(avatar); left.appendChild(authorWrap);

      const actionsTop = document.createElement('div');
      const pokeBtn = document.createElement('button'); pokeBtn.className='btn'; pokeBtn.textContent='Cutucar'; pokeBtn.onclick = () => pokeUser(p.author);
      actionsTop.appendChild(pokeBtn);

      header.appendChild(left); header.appendChild(actionsTop);

      // content
      const content = document.createElement('div'); content.className='post-content'; content.style.marginTop='8px';
      content.textContent = p.text || '';

      // bottom actions
      const bottom = document.createElement('div'); bottom.className='post-actions'; bottom.style.display='flex'; bottom.style.gap='8px'; bottom.style.marginTop='10px'; bottom.style.justifyContent='flex-end';
      const likeBtn = document.createElement('button'); likeBtn.className='btn like-btn';
      const likeCount = Number(p.likes || 0);
      likeBtn.innerHTML = `<span class="like-count">${likeCount}</span> Curtir`;
      likeBtn.onclick = async () => { await toggleLike(doc.id, likeBtn); };
      const commentBtn = document.createElement('button'); commentBtn.className='btn comment-btn'; commentBtn.textContent = 'Coment√°rios'; commentBtn.onclick = () => toggleComments(doc.id);
      const shareBtn = document.createElement('button'); shareBtn.className='btn'; shareBtn.textContent = 'Compartilhar'; shareBtn.onclick = () => sharePost(doc.id);
      bottom.appendChild(likeBtn); bottom.appendChild(commentBtn); bottom.appendChild(shareBtn);

      // comments area (hidden by default)
      const commentsWrap = document.createElement('div'); commentsWrap.id = `comments-${doc.id}`; commentsWrap.className='comments-wrap'; commentsWrap.style.display='none'; commentsWrap.style.marginTop='12px';
      const commentsList = document.createElement('div'); commentsList.id = `comments-list-${doc.id}`; commentsList.className='muted comments-list'; commentsList.textContent = 'Carregando coment√°rios...';
      const commentRow = document.createElement('div'); commentRow.className='comment-row'; commentRow.style.display='flex'; commentRow.style.gap='8px'; commentRow.style.marginTop='8px';
      const input = document.createElement('input'); input.id = `comment-input-${doc.id}`; input.placeholder = 'Escreva um coment√°rio...'; input.className='comment-input'; input.style.flex='1'; input.style.padding='8px'; input.style.borderRadius='8px'; input.style.border='1px solid rgba(0,255,156,0.06)'; input.value = '';
      const sendBtn = document.createElement('button'); sendBtn.className='btn comment-send'; sendBtn.textContent='Enviar'; sendBtn.onclick = () => addComment(doc.id);
      commentRow.appendChild(input); commentRow.appendChild(sendBtn);
      commentsWrap.appendChild(commentsList); commentsWrap.appendChild(commentRow);

      postEl.appendChild(header); postEl.appendChild(content); postEl.appendChild(bottom); postEl.appendChild(commentsWrap);
      feedEl.appendChild(postEl);
    }
  } catch (e) {
    console.error('loadFeed error', e);
  }
}

// toggle like using transaction
async function toggleLike(postId, buttonEl) {
  if (!db) return null;
  const postRef = db.collection('posts').doc(postId);
  try {
    const result = await db.runTransaction(async tx => {
      const snap = await tx.get(postRef);
      if (!snap.exists) return null;
      const data = snap.data() || {};
      const likedBy = Array.isArray(data.likedBy) ? data.likedBy.slice() : [];
      let likes = Number(data.likes || 0);
      if (likedBy.includes(nomeUsuario)) {
        const newLikes = Math.max(0, likes - 1);
        tx.update(postRef, { likes: newLikes, likedBy: firebase.firestore.FieldValue.arrayRemove(nomeUsuario) });
        return { action: 'unliked', likes: newLikes };
      } else {
        const newLikes = likes + 1;
        tx.update(postRef, { likes: newLikes, likedBy: firebase.firestore.FieldValue.arrayUnion(nomeUsuario) });
        return { action: 'liked', likes: newLikes };
      }
    });
    if (!result) return null;
    // update UI
    const cnt = result.likes;
    if (buttonEl) {
      const span = buttonEl.querySelector('.like-count');
      if (span) span.textContent = cnt;
      buttonEl.innerHTML = `<span class="like-count">${cnt}</span> Curtir`;
    }
    try { await addActivity(`${nomeUsuario} ${result.action === 'liked' ? 'curtiu' : 'deixou de curtir'} um post`); } catch(e){}
    if (result.action === 'liked') try { revealAchievement('ach_like'); } catch(e){}
    return result.action;
  } catch (e) {
    console.error('toggleLike error', e);
    return null;
  }
}

// add comment to post (subcollection posts/{id}/comments)
async function addComment(postId) {
  try {
    const input = document.getElementById(`comment-input-${postId}`);
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    const payload = { author: nomeUsuario, avatar: localStorage.getItem('avatar') || defaultAvatar, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection('posts').doc(postId).collection('comments').add(payload);
    input.value = '';
    try { await addActivity(`${nomeUsuario} comentou`); } catch(e){}
    try { revealAchievement('ach_comment'); } catch(e){}
    // optimistic update: append comment to list
    const listEl = document.getElementById(`comments-list-${postId}`);
    if (listEl) {
      const item = document.createElement('div'); item.className='comment'; item.style.marginTop='6px';
      item.innerHTML = `<div class="comment-meta" style="display:flex;gap:8px;align-items:center"><img class="comment-avatar" src="${escapeHtml(payload.avatar)}" style="width:28px;height:28px;border-radius:50%"/><strong>${escapeHtml(payload.author)}</strong></div><div class="comment-body">${escapeHtml(payload.text)}</div>`;
      if (listEl.querySelector('.small.muted')) listEl.innerHTML = '';
      listEl.appendChild(item);
      listEl.scrollTop = listEl.scrollHeight;
    }
    // ensure live listener loads eventual new comments
    if (!_commentUnsubs[postId]) setTimeout(()=> loadComments(postId).catch(()=>{}), 600);
  } catch (e) { console.error('addComment error', e); }
}

async function loadComments(postId) {
  try {
    const listEl = document.getElementById(`comments-list-${postId}`);
    if (!listEl) return;
    listEl.innerHTML = '<div style="opacity:.6">Carregando coment√°rios...</div>';
    const snap = await db.collection('posts').doc(postId).collection('comments').orderBy('createdAt','asc').get();
    listEl.innerHTML = '';
    snap.forEach(doc => {
      const c = doc.data() || {};
      const item = document.createElement('div'); item.className='comment'; item.style.marginTop='6px';
      item.innerHTML = `<div class="comment-meta" style="display:flex;gap:8px;align-items:center"><img class="comment-avatar" src="${escapeHtml(c.avatar || defaultAvatar)}" style="width:28px;height:28px;border-radius:50%"/><strong>${escapeHtml(c.author || 'Usu√°rio')}</strong></div><div class="comment-body">${escapeHtml(c.text || '')}</div>`;
      listEl.appendChild(item);
    });
    if (!snap.size) listEl.innerHTML = '<div class="small muted">Sem coment√°rios ainda.</div>';
  } catch (e) { console.error('loadComments error', e); }
}

function toggleComments(postId) {
  try {
    const wrap = document.getElementById(`comments-${postId}`);
    if (!wrap) return;
    const isHidden = (wrap.style.display === 'none' || wrap.style.display === '');
    if (isHidden) {
      wrap.style.display = 'block';
      // attach realtime listener for comments if not already
      if (_commentUnsubs[postId]) return;
      const ref = db.collection('posts').doc(postId).collection('comments').orderBy('createdAt','asc');
      _commentUnsubs[postId] = ref.onSnapshot(snap => {
        if (!snap) return;
        renderCommentsListFromDocs(postId, snap.docs);
      }, err => console.warn('comments onSnapshot error', err));
    } else {
      wrap.style.display = 'none';
      if (_commentUnsubs[postId]) { try { _commentUnsubs[postId](); } catch(e){} delete _commentUnsubs[postId]; }
    }
  } catch (e) { console.error('toggleComments error', e); }
}

function renderCommentsListFromDocs(postId, docs) {
  try {
    const listEl = document.getElementById(`comments-list-${postId}`);
    if (!listEl) return;
    listEl.innerHTML = '';
    if (!docs || docs.length === 0) { listEl.innerHTML = '<div class="small muted">Sem coment√°rios ainda.</div>'; return; }
    docs.forEach(doc => {
      const c = doc.data() || {};
      const item = document.createElement('div'); item.className='comment'; item.style.marginTop='6px';
      item.innerHTML = `<div class="comment-meta" style="display:flex;gap:8px;align-items:center"><img class="comment-avatar" src="${escapeHtml(c.avatar || defaultAvatar)}" style="width:28px;height:28px;border-radius:50%"/><strong>${escapeHtml(c.author || 'Usu√°rio')}</strong></div><div class="comment-body">${escapeHtml(c.text || '')}</div>`;
      listEl.appendChild(item);
    });
  } catch (e) { console.error('renderCommentsListFromDocs error', e); }
}

// safe poke/share stubs (used by post UI)
window.pokeUser = async function(targetName) {
  try {
    if (!targetName || targetName === nomeUsuario) { showToast('N√£o √© poss√≠vel cutucar voc√™ mesmo'); return; }
    if (db) {
      try { await db.collection('notifications').add({ to: targetName, from: nomeUsuario, type:'poke', text:`${nomeUsuario} cutucou voc√™`, createdAt: firebase.firestore.FieldValue.serverTimestamp(), read:false }); } catch(e){}
    }
    try { await addActivity(`${nomeUsuario} cutucou ${targetName}`); } catch(e){}
    showToast('Cutucada enviada');
  } catch (e) { console.warn('pokeUser', e); }
};

window.sharePost = async function(postId) {
  try {
    if (!postId) return;
    const url = window.location.origin + window.location.pathname + '?post=' + encodeURIComponent(postId);
    try { await navigator.clipboard.writeText(url); showToast('Link copiado'); } catch(e){ showToast('Copiar link falhou'); }
  } catch (e) { console.warn('sharePost', e); }
};

  /* ---------- Initialization (runs last) ---------- */
async function initApp(){
  try {
    await ensureUserDoc();
    // load profile then other parts
    await loadProfileInternal();
    // realtime
    watchPostsRealtime();
    // bind UI
    bindCourseButtons();
    // initial loads ‚Äî n√£o carregar lista completa de usu√°rios automaticamente (evita duplica√ß√£o)
    loadUserSuggestions().catch(()=>{});
    // loadUsersList intentionally NOT called here ‚Äî usersList appears only on search
    loadFriendsList().catch(()=>{});
    loadLeaderboard().catch(()=>{});
    loadActivity().catch(()=>{});
    loadLegacyCourseScores().catch(()=>{});
    loadCourseScores().catch(()=>{}); // tabela de pontua√ß√£o dos cursos
  } catch(e) { console.error('initApp error', e); }
}

// loadProfileInternal ensures functions are called in right order (called from initApp)
async function loadProfileInternal(){
  try {
    const doc = await ensureUserDoc();
    const data = doc ? doc.data() : {};
    document.getElementById('profile-name').textContent = data.nome || nomeUsuario;
    document.getElementById('avatar-img').src = data.avatar || defaultAvatar;
    document.getElementById('post-avatar').src = data.avatar || defaultAvatar;
    localStorage.setItem('avatar', data.avatar || defaultAvatar);
    const xp = data.xp || 0;
    const { level, progress, next } = calcLevel(xp);
    document.getElementById('profile-level').textContent = 'N√≠vel ' + level;
    const percent = Math.round((progress / next) * 100);
    const xpFill = document.getElementById('xp-fill');
    if (xpFill) xpFill.style.width = percent + '%';
    const xpText = document.getElementById('xp-text');
    if (xpText) xpText.textContent = `${xp} XP ‚Ä¢ ${progress}/${next}`;
    if (typeof updateOrb === 'function') updateOrb(percent);
    // render achievements button will call renderAchievements when opened
  } catch(e){ console.error('loadProfileInternal', e); }
}

// wire simple UI buttons that exist in markup
document.getElementById('logout-btn').onclick = () => {
  if (firebase.auth) firebase.auth().signOut().catch(()=>{});
  localStorage.clear();
  window.location.href = 'login.html';
};
document.getElementById('edit-profile-btn').onclick = async () => {
  const newName = prompt('Editar nome:', nomeUsuario);
  if (!newName) return;
  const q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
  if (!q.empty) {
    await q.docs[0].ref.update({ nome: newName });
    localStorage.setItem('usuario', newName);
    window.location.reload();
  }
};

// removed duplicate `searchBtn` handler (click is wired above to call searchUsers)
// use the debounced searchUsers() binding declared earlier to handle clicks and Enter

/* ---------- Missing UI bindings & helpers (restoration) ---------- */

/* Mostrar / selecionar avatar (definido cedo para evitar ReferenceError no onclick do HTML) */
window.mostrarOpcoesAvatar = function() {
  try {
    var sel = document.getElementById('selecao-avatar');
    if (!sel) return;
    sel.style.display = (sel.style.display === 'flex') ? 'none' : 'flex';
  } catch (e) { console.warn('mostrarOpcoesAvatar', e); }
};

window.selecionarAvatar = async function(path) {
  try {
    if (!path) return;
    var a = document.getElementById('avatar-img');
    var p = document.getElementById('post-avatar');
    if (a) a.src = path;
    if (p) p.src = path;
    localStorage.setItem('avatar', path);
    // atualizar doc do usu√°rio no Firestore (se dispon√≠vel)
    if (typeof db !== 'undefined' && db) {
      try {
        var q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        if (!q.empty) await q.docs[0].ref.update({ avatar: path }).catch(()=>{});
      } catch(e){ console.warn('selecionarAvatar firestore', e); }
    }
    var sel = document.getElementById('selecao-avatar'); if (sel) sel.style.display = 'none';
    try { showToast('Avatar atualizado'); } catch(e){}
  } catch (e) { console.error('selecionarAvatar', e); }
};


/* Mapear bot√µes de curso / "Ir para Cursos" */
function bindCourseButtons(){
  try {
    var MAP = {
      empatia: 'modulo1.html',
      equipe: 'modulo2.html',
      emocional: 'modulo1.html',
      comunicacao: 'comunica√ß√£o.html'
    };
    // course buttons: ao clicar, rolar at√© se√ß√£o de cursos (se existir) ou abrir p√°gina
    var btns = Array.prototype.slice.call(document.querySelectorAll('.course-btn'));
    btns.forEach(function(btn){
      try {
        btn.removeEventListener('click', btn._handler);
      } catch(e){}
      btn._handler = function(){
        var course = btn.dataset && btn.dataset.course;
        var cursosAnchor = document.getElementById('cursos');
        if (cursosAnchor) {
          // rolar at√© a se√ß√£o de cursos (experi√™ncia integrada)
          cursosAnchor.scrollIntoView({ behavior:'smooth', block:'start' });
          // se quiser destacar o curso, n√£o h√° identifica√ß√£o por linha ‚Äî mantemos central behavior
        } else {
          var dest = MAP[course] || (course + '.html');
          window.location.href = dest;
        }
      };
      btn.addEventListener('click', btn._handler);
    });

    // bot√£o "Ir para os Cursos" (header)
    var goto = document.getElementById('gotoCourses');
    if (goto) {
      goto.removeEventListener('click', goto._handler);
      goto._handler = function() {
        var cursosAnchor = document.getElementById('cursos');
        if (cursosAnchor) cursosAnchor.scrollIntoView({ behavior:'smooth', block:'start' });
        else window.location.href = 'central.html#cursos';
      };
      goto.addEventListener('click', goto._handler);
    }
  } catch(e){ console.warn('bindCourseButtons', e); }
}
window.bindCourseButtons = bindCourseButtons;


/* Friends list (quem voc√™ segue) */
async function loadFriendsList(){
  try {
    var el = document.getElementById('friends');
    if (!el) return;
    el.innerHTML = 'Carregando...';
    if (!db) { el.innerHTML = '<div class="muted">Offline</div>'; return; }
    var meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    if (meSnap.empty) { el.innerHTML = '<div>Nenhum amigo encontrado.</div>'; return; }
    var meData = meSnap.docs[0].data() || {};
    var following = Array.isArray(meData.following) ? meData.following : [];
    if (following.length === 0) { el.innerHTML = '<div>Voc√™ ainda n√£o segue ningu√©m.</div>'; return; }
    el.innerHTML = '';
    // carregar at√© 12 perfis seguidos
    var count = 0;
    for (var i = 0; i < following.length && count < 12; i++) {
      try {
        var name = following[i];
        var snaps = await db.collection('usuarios').where('nome','==',name).limit(1).get();
        if (snaps.empty) continue;
        var u = snaps.docs[0].data() || {};
        var id = snaps.docs[0].id;
        var row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.gap = '8px';
        row.style.padding = '6px 8px';
        row.style.border = '1px solid rgba(0,255,156,0.04)';
        row.style.borderRadius = '10px';
        row.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><img src="'+(u.avatar||defaultAvatar)+'" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #00ff9c"><div><div style="font-weight:700;color:#00ff9c">'+escapeHtml(u.nome)+'</div><div class="muted" style="font-size:12px">'+escapeHtml(u.tipo||'')+'</div></div></div><div style="display:flex;gap:8px"><button class="btn" onclick="openProfileModal(\''+escapeHtml(u.nome)+'\')">Perfil</button><button class="btn unfollowBtn" data-name="'+escapeHtml(u.nome)+'" data-id="'+id+'">Deixar de seguir</button></div>';
        el.appendChild(row);
        count++;
      } catch(e){ console.warn('loadFriendsList item', e); }
    }
    // attach unfollow handlers
    Array.prototype.slice.call(document.querySelectorAll('.unfollowBtn')).forEach(function(b){
      try { b.removeEventListener('click', b._handler); } catch(e){}
      b._handler = async function(e){
        var name = e.currentTarget.dataset.name;
        var id = e.currentTarget.dataset.id;
        await unfollowUser(name, id);
        loadFriendsList().catch(()=>{});
        loadUserSuggestions().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });
  } catch(e){ console.error('loadFriendsList', e); }
}
window.loadFriendsList = loadFriendsList;


/* Leaderboard (top XP) */
async function loadLeaderboard(){
  try {
    var el = document.getElementById('leaderboard');
    if (!el) return;
    el.innerHTML = '<li>Carregando...</li>';
    if (!db) { el.innerHTML = '<li class="muted">Offline</li>'; return; }
    var snap = await db.collection('usuarios').orderBy('xp','desc').limit(10).get();
    el.innerHTML = '';
    if (!snap || snap.empty) { el.innerHTML = '<li>Nenhum usu√°rio</li>'; return; }
    snap.forEach(function(doc){
      var d = doc.data() || {};
      var li = document.createElement('li');
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.padding = '6px 8px';
      li.innerHTML = '<span><strong>'+escapeHtml(d.nome || '')+'</strong></span><span>'+(Number(d.xp||0))+' XP</span>';
      el.appendChild(li);
    });
  } catch(e){ console.error('loadLeaderboard', e); }
}
window.loadLeaderboard = loadLeaderboard;


/* Recent activity feed (atividades recentes) */
async function loadActivity(){
  try {
    const container = document.getElementById('activity-feed');
    if (!container) return;
    container.innerHTML = 'Carregando...';
    if (!db) { container.innerHTML = '<div class="muted">Offline</div>'; return; }

    // helper: formata hor√°rio apenas (hh:mm)
    function formatTime(raw){
      if (!raw) return '';
      try {
        if (raw && typeof raw.toDate === 'function') return raw.toDate().toLocaleTimeString();
        if (raw && typeof raw.seconds === 'number') return new Date(raw.seconds * 1000).toLocaleTimeString();
        const d = new Date(raw);
        if (!isNaN(d)) return d.toLocaleTimeString();
      } catch(e){}
      return '';
    }

    // buscar atividades (prefer 'activities', fallback 'atividades')
    let snap = await db.collection('activities').orderBy('createdAt','desc').limit(24).get().catch(()=>null);
    if (!snap || snap.empty) {
      snap = await db.collection('atividades').orderBy('createdAt','desc').limit(24).get().catch(()=>null) || snap;
    }

    container.innerHTML = '';
    if (!snap || snap.empty) { container.innerHTML = '<div class="small muted">Nenhuma atividade recente.</div>'; return; }

    // limitar visualiza√ß√£o e deduplicar (por texto+ts)
    const seen = new Set();
    const MAX_SHOW = 6;
    let shown = 0;
    for (const doc of snap.docs) {
      if (shown >= MAX_SHOW) break;
      const d = doc.data() || {};
      const rawTs = d.createdAt || d.ts || d.time || d.date || null;
      const timeStr = formatTime(rawTs) || '';
      const text = (d.text || d.message || d.activity || '').trim();
      const key = (text + '|' + (rawTs && rawTs.seconds ? rawTs.seconds : String(rawTs||''))).slice(0,200);
      if (seen.has(key)) continue;
      seen.add(key);

      // mostra apenas hor√°rio, com tooltip contendo a descri√ß√£o completa
      const row = document.createElement('div');
      row.style.padding = '6px 8px';
      row.style.borderBottom = '1px solid rgba(0,255,156,0.02)';
      row.title = truncate(text || 'Atividade', 200); // tooltip com conte√∫do
      row.innerHTML = `<div class="muted" style="font-size:13px;">${escapeHtml(timeStr || '')}</div>`;
      container.appendChild(row);
      shown++;
    }

    if (shown === 0) {
      container.innerHTML = '<div class="small muted">Nenhuma atividade recente.</div>';
    } else if (snap.size > shown) {
      // link discreto para mostrar mais (mant√©m UI enxuta)
      const more = document.createElement('div');
      more.style.padding = '6px 8px';
      more.style.textAlign = 'center';
      more.innerHTML = `<a href="#" style="color:var(--neon);font-size:13px" id="show-more-acts">Ver mais</a>`;
      container.appendChild(more);
      const a = document.getElementById('show-more-acts');
      if (a) a.addEventListener('click', (e) => {
        e.preventDefault();
        // ao clicar, renderiza at√© 20 items com hor√°rio + texto reduzido
        container.innerHTML = '';
        let count = 0;
        for (const doc of snap.docs) {
          if (count >= 20) break;
          const d = doc.data() || {};
          const rawTs = d.createdAt || d.ts || d.time || d.date || null;
          const timeStr = formatTime(rawTs) || '';
          const text = truncate((d.text || d.message || d.activity || ''), 80);
          const row = document.createElement('div');
          row.style.padding = '6px 8px';
          row.style.borderBottom = '1px solid rgba(0,255,156,0.02)';
          row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div class="muted" style="font-size:13px">${escapeHtml(timeStr)}</div><div style="font-size:12px;color:var(--muted);margin-left:8px">${escapeHtml(text)}</div></div>`;
          container.appendChild(row);
          count++;
        }
      });
    }

  } catch(e){ console.error('loadActivity', e); }
}
window.loadActivity = loadActivity;


/* Legacy course scores / bottom table */
async function loadCourseScores(){
  try {
    var container = document.getElementById('course-scores-bottom');
    if (!container) return;
    container.innerHTML = 'Carregando...';
    if (!db) { container.innerHTML = '<div class="muted">Offline</div>'; return; }

    var KNOWN = {
      '√©tica':'√©tica',
      'comunicacao':'Comunica√ß√£o',
      'empatia':'Empatia',
      'equipe':'Trabalho em Equipe',
      'emocional':'Intelig√™ncia Emocional'
    };

    var snap = await db.collection('pontuacoes').get().catch(()=>null);
    var byCourse = {};
    if (snap && !snap.empty) {
      snap.forEach(function(doc){
        var d = doc.data() || {};
        var raw = String(d.curso || '').trim();
        if (!raw) return;
        var k = raw.toLowerCase();
        byCourse[k] = byCourse[k] || { nome: raw, best: 0, count: 0 };
        var pts = Number(d.pontuacao || 0);
        byCourse[k].count++;
        if (pts > byCourse[k].best) byCourse[k].best = pts;
      });
    }

    // ensure known courses present
    Object.keys(KNOWN).forEach(function(k){
      if (!byCourse[k]) byCourse[k] = { nome: KNOWN[k], best: 0, count: 0 };
      else byCourse[k].nome = KNOWN[k];
    });

    var keys = Object.keys(byCourse).sort(function(a,b){ return byCourse[b].best - byCourse[a].best; });

    // build table
    var table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.innerHTML = '<thead><tr><th style="text-align:left;padding:8px">Curso</th><th style="padding:8px">Melhor</th><th style="padding:8px">Entradas</th></tr></thead>';
    var tbody = document.createElement('tbody');
    keys.forEach(function(k){
      var c = byCourse[k];
      var tr = document.createElement('tr');
      tr.innerHTML = '<td style="padding:8px;text-align:left">'+escapeHtml(c.nome)+'</td><td style="padding:8px">'+(c.best||0)+'</td><td style="padding:8px">'+(c.count||0)+'</td>';
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.innerHTML = '';
    container.appendChild(table);
  } catch(e){ console.error('loadCourseScores', e); try { document.getElementById('course-scores-bottom') && (document.getElementById('course-scores-bottom').innerText = 'Erro ao carregar pontua√ß√µes.'); } catch(e){} }
}
window.loadCourseScores = loadCourseScores;


/* Achievements button (abre modal e renderAchievements se existir) */
(function(){
  try {
    var ach = document.getElementById('openAchievements');
    if (!ach) return;
    ach.removeEventListener('click', ach._handler);
    ach._handler = function(){
      var m = document.getElementById('achievementsModal');
      if (!m) return;
      m.classList.toggle('hidden');
      if (!m.classList.contains('hidden') && typeof renderAchievements === 'function') {
        try { renderAchievements(); } catch(e){ console.warn(e); }
      }
    };
    ach.addEventListener('click', ach._handler);
  } catch(e){ console.warn('ach handler', e); }
})();

// compat: alias para evitar ReferenceError (chamado em outros pontos)
async function loadLegacyCourseScores() {
  if (typeof loadCourseScores === 'function') {
    return loadCourseScores();
  }
  return Promise.resolve();
}
window.loadLegacyCourseScores = loadLegacyCourseScores;

// iniciar aplica√ß√£o ap√≥s DOM e autentica√ß√£o
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const ok = await ensureLoggedInOrRedirect();
    if (!ok) return;
    // carrega app (tratamento de erro para n√£o travar)
    try { await initApp(); } catch(e){ console.error('initApp runtime error', e); }
  } catch (e) {
    console.error('startup error', e);
  }
});

  </script>

</body>
</html>
