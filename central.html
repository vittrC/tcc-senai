<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VAULT CENTER - Central de usu√°rios</title>
  <link rel="stylesheet" href="css/stylecentral.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <!-- favicon inline para evitar 404 sem precisar de arquivo externo -->
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="18" fill="%2300150f"/><circle cx="50" cy="50" r="28" fill="%2300ff9c" fill-opacity="0.16"/><text x="50" y="58" font-size="42" text-anchor="middle" fill="%2300ff9c" font-family="Lexend Deca, Arial">V</text></svg>' type="image/svg+xml">
  
  <style>
    /* Ajustes espec√≠ficos da p√°gina para alinhamento */
    .grid-layout { max-width:1200px; margin:20px auto; padding:16px; display:grid; grid-template-columns:300px 1fr 320px; gap:18px; align-items:start; }
    .hidden { display:none !important; }
    /* modal central */
    #profileModal .modal-card { background:linear-gradient(180deg,#041817,#062d2a); padding:18px; border-radius:10px; color:inherit; }
    /* override avatar selector fixed -> keep near profile card */
    #perfil-icone { position:relative; }
    #selecao-avatar { position:relative; top:0; right:0; display:flex; flex-wrap:wrap; gap:6px; justify-content:center; padding-top:8px; }
    /* alinhamento do feed */
    .post .post-top .meta { align-items:center; }
    .post .post-actions { justify-content:flex-end; }
    /* make follow buttons consistent */
    .followBtn { min-width:90px; }
    @media (max-width:1000px){ .grid-layout { grid-template-columns:1fr; } .xp-bar{width:100%} }
    .tag-chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,255,156,0.12);
      background: linear-gradient(90deg, rgba(0,255,156,0.02), rgba(0,255,156,0.01));
      color: var(--neon);
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 6px 18px rgba(0,255,156,0.03);
    }
    .tag-chip:hover { transform:translateY(-2px); transition:transform .15s ease; box-shadow:0 10px 30px rgba(0,255,156,0.06); }
  </style>
</head>
<body>
  <canvas id="neonCanvas"></canvas>

  <div class="grid-layout">
    <!-- Perfil / Sidebar -->
    <div class="card profile-card">
      <div id="perfil-icone" onclick="mostrarOpcoesAvatar()">
        <img id="avatar-img" src="img/img1.png" alt="Avatar" />
      </div>

      <h2 id="profile-name">Usu√°rio</h2>
      <div class="level-badge" id="profile-level">N√≠vel 1</div>

      <div class="xp-bar" title="Progresso para pr√≥ximo n√≠vel">
        <div class="xp-fill" id="xp-fill" style="width:0%"></div>
      </div>
      <div style="margin-top:8px; font-size:13px;" id="xp-text">0 XP ‚Ä¢ 0/100</div>

      <div class="streak" id="profile-streak">üî• Streak: 0 dias</div>

      <div class="badges" id="profile-badges">
        <!-- Badges din√¢micas -->
      </div>

      <!-- Tags / interesses do usu√°rio -->
      <div id="profile-tags" style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;"></div>
      <!-- fim tags -->

      <div style="margin-top:12px; display:flex; gap:8px;">
        <button class="btn" id="edit-profile-btn">Editar</button>
        <button class="btn btn-ghost" id="logout-btn">Sair</button>
      </div>

      <hr style="margin:12px 0; border-color:rgba(255,255,255,0.03)">

      <!-- Seletor de avatar: 12 imagens -->
      <div id="selecao-avatar" style="margin-top:10px; display:none; width:100%;">
        <div class="avatar-grid">
          <img src="img/img1.png" class="avatar" onclick="selecionarAvatar('img/img1.png')" alt="a1">
          <img src="img/img2.png" class="avatar" onclick="selecionarAvatar('img/img2.png')" alt="a2">
          <img src="img/img3.png" class="avatar" onclick="selecionarAvatar('img/img3.png')" alt="a3">
          <img src="img/img4.png" class="avatar" onclick="selecionarAvatar('img/img4.png')" alt="a4">
          <img src="img/img5.png" class="avatar" onclick="selecionarAvatar('img/img5.png')" alt="a5">
          <img src="img/img6.png" class="avatar" onclick="selecionarAvatar('img/img6.png')" alt="a6">
          <img src="img/img7.png" class="avatar" onclick="selecionarAvatar('img/img7.png')" alt="a7">
          <img src="img/img8.png" class="avatar" onclick="selecionarAvatar('img/img8.png')" alt="a8">
          <img src="img/img9.png" class="avatar" onclick="selecionarAvatar('img/img9.png')" alt="a9">
          <img src="img/img10.png" class="avatar" onclick="selecionarAvatar('img/img10.png')" alt="a10">
          <img src="img/img11.png" class="avatar" onclick="selecionarAvatar('img/img11.png')" alt="a11">
          <img src="img/img12.png" class="avatar" onclick="selecionarAvatar('img/img12.png')" alt="a12">
        </div>
      </div>
    </div>

    <!-- Feed / Conte√∫do central -->
    <div>
      <section class="hero">
        <h1 style="margin:6px 0 4px 0;">VAULT CENTER</h1>
        <p style="margin:0 0 6px 0; color:#9eeed1;">Acompanhe seu progresso, compartilhe conquistas e veja o que outros est√£o aprendendo.</p>
        <div style="text-align:center; margin-top:10px;">
          <button id="gotoCourses" class="btn">Ir para os Cursos</button>
          <button id="openAchievements" class="btn" style="margin-left:10px;">Conquistas</button>
        </div>
      </section>

      <div class="card post-box">
        <div style="display:flex; gap:10px; align-items:flex-start;">
          <img id="post-avatar" src="img/img1.png" alt="me" style="width:48px;height:48px;border-radius:50%;border:2px solid #00ff9c;object-fit:cover">
          <div style="flex:1;">
            <textarea id="post-text" class="post-textarea" placeholder="Compartilhe uma conquista, dica ou d√∫vida..."></textarea>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
              <button class="btn" id="post-btn">Publicar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="feed" id="feed">
        <!-- Posts carregados dinamicamente -->
      </div>

      <!-- Pontua√ß√£o geral (gr√°fico) -->
      <!-- <div class="card" style="margin-top:12px;">
        <h3>Sua Pontua√ß√£o</h3>
        <div style="height:180px;">
          <canvas id="scoreChart"></canvas>
        </div>
      </div> -->
    </div>

    <!-- Right sidebar: leaderboard e amigos -->
    <div>
      <div class="card">
        <h3>Leaderboard</h3>
        <ol id="leaderboard" class="leaderboard" style="margin:0;padding:0;"></ol>
      </div>

      <!-- separa pesquisa de usu√°rios (novo card) -->
      <div class="card" style="margin-top:12px;">
        <h3>Pesquisar Usu√°rios</h3>
        <div id="users-search" style="margin-bottom:10px;">
          <input id="search-user" type="text" placeholder="Buscar usu√°rio..." style="width:100%;padding:6px;border-radius:6px;border:1px solid #00ff9c;background:#041817;color:#00ff9c;">
          <button class="btn" id="search-btn" style="margin-top:6px;width:100%;">Buscar</button>
        </div>

        <div id="usersList" style="display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;">
          <!-- Resultados da busca aparecer√£o aqui (n√£o incluem usu√°rios que voc√™ j√° segue) -->
          <div class="muted small">Digite um nome para buscar (resultados ocultam quem voc√™ j√° segue).</div>
        </div>
      </div>

      <!-- Amigos / Seguindo (separado para evitar duplica√ß√£o) -->
      <div class="card" style="margin-top:12px;">
        <h3>Amigos / Seguindo</h3>
        <div id="friends" class="friends-list" style="display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Atividades Recentes</h3>
        <div id="activity-feed" style="font-size:13px;color:#9eeed1; display:flex;flex-direction:column;gap:6px;"></div>
      </div>

    </div>

  </div>

  <!-- Cursos (grid de baixo permanece) -->
  <h2 id="cursos" style="text-align:center;margin-top:24px;color:#00ff9c">Cursos Dispon√≠veis</h2>
  <section class="course-grid">
    <div class="course-card">
      <span class="material-symbols-outlined">volunteer_activism</span>
      <h3 class="course-title">Empatia</h3>
      <p class="course-desc">Aprenda a se colocar no lugar do outro e fortalecer conex√µes no ambiente de trabalho.</p>
      <button class="btn course-btn" data-course="empatia" title="Abrir Empatia">
      Acessar
      </button>
    </div>
    <div class="course-card">
      <span class="material-symbols-outlined">diversity_3</span>
      <h3 class="course-title">Trabalho em Equipe</h3>
      <p class="course-desc">Descubra t√©cnicas para colabora√ß√£o eficiente e alcance metas em conjunto.</p>
      <button class="btn course-btn" data-course="equipe" title="Abrir Trabalho em Equipe">
        Acessar
      </button>
    </div>
    <div class="course-card">
      <span class="material-symbols-outlined">neurology</span>
      <h3 class="course-title">Intelig√™ncia Emocional</h3>
      <p class="course-desc">Domine suas emo√ß√µes e melhore a tomada de decis√µes em situa√ß√µes desafiadoras.</p>
      <button class="btn course-btn" data-course="emocional" title="Abrir Intelig√™ncia Emocional">
        Acessar
      </button>
    </div>
    <div class="course-card">
      <span class="material-symbols-outlined">record_voice_over</span>
      <h3 class="course-title">Comunica√ß√£o</h3>
      <p class="course-desc">Aprimore suas habilidades de comunica√ß√£o para transmitir mensagens claras e eficazes.</p>
      <button class="btn course-btn" data-course="comunicacao" title="Abrir Comunica√ß√£o">
        Acessar
      </button>
    </div>
  </section>

  <!-- Modal de Conquistas (fix: garante que bot√£o "Conquistas" funcione) -->
  <div id="achievementsModal" class="hidden">
    <div class="ach-card">
      <button class="btn-exit" style="background:transparent;  border:2px solid var(--neon); color:var(--neon);  padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; box-shadow:0 6px 20px rgba(0,255,156,0.06);" onclick="document.getElementById('achievementsModal').classList.add('hidden')">‚úï</button>
      <h3>Conquistas</h3>
      <div class="ach-grid"></div>
    </div>
  </div>

  <!-- REPLACE profileModal with enhanced profile modal -->
  <div id="profileModal" class="hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:800;">
    <div class="modal-card" style="width:920px; max-width:95%; display:flex; gap:16px; padding:0; overflow:hidden;">
      <div style="flex:1; background:linear-gradient(180deg,#041817,#062d2a); color:inherit;">
        <div id="modalBanner" style="height:110px; background:linear-gradient(90deg, rgba(0,255,156,0.06), rgba(0,255,156,0.02)); display:flex; align-items:flex-end; padding:12px;">
          <img id="modalAvatar" src="img/img1.png" style="width:96px;height:96px;border-radius:50%;border:3px solid #00ff9c;object-fit:cover; background:#002; margin-bottom:-36px;" />
        </div>
        <div style="padding:56px 18px 18px 18px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div>
              <h2 id="modalName" style="margin:0;color:var(--neon)"></h2>
              <div id="modalMeta" style="color:var(--muted); font-size:13px; margin-top:6px;"></div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="modalEditBtn" class="btn" style="display:none">Editar</button>
              <button id="modalFollowBtn" class="btn" style="display:inline-block"></button>
              <button onclick="closeProfileModal()" class="btn btn-ghost" style="margin-left:4px">Fechar</button>
            </div>
          </div>

          <p id="modalBio" style="color:var(--muted); margin-top:12px;"></p>

          <div style="margin-top:12px;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <strong style="color:var(--neon)">Interesses</strong>
              <span id="modalAffinity" style="color:var(--muted); font-size:13px;"></span>
            </div>
            <div id="modalTags" style="display:flex; gap:8px; flex-wrap:wrap;"></div>

            <!-- edit area (hidden until edit mode) -->
            <div id="modalEditArea" style="margin-top:12px; display:none;">
              <input id="editName" placeholder="Nome" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(0,255,156,0.06); background:transparent; color:var(--neon)"/>
              <textarea id="editBio" placeholder="Bio" style="width:100%; margin-top:8px; padding:8px; border-radius:8px; border:1px solid rgba(0,255,156,0.06); background:transparent; color:var(--muted)"></textarea>
              <input id="editBanner" placeholder="URL do banner" style="width:100%; padding:8px; margin-top:8px; border-radius:8px; border:1px solid rgba(0,255,156,0.06); background:transparent; color:var(--neon)"/>
              <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
                <input id="newTagInput" placeholder="Adicionar tag (ex: Empatia)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,255,156,0.06);background:transparent;color:var(--neon)"/>
                <button id="addTagBtn" class="btn">Adicionar</button>
              </div>
              <div id="editTagsList" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
              <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                <button id="cancelEditBtn" class="btn btn-ghost">Cancelar</button>
                <button id="saveEditBtn" class="btn">Salvar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <aside style="width:320px; max-width:40%; background:linear-gradient(180deg,#031514,#042522); padding:14px; border-left:1px solid rgba(0,255,156,0.04);">
        <h4 style="margin:0 0 8px 0; color:var(--neon)">Resumo</h4>
        <div id="modalStats" style="color:var(--muted); font-size:13px; margin-bottom:12px;"></div>

        <h4 style="margin:8px 0 8px 0; color:var(--neon)">Atividades recentes</h4>
        <div id="modalActivities" style="max-height:240px; overflow:auto; display:flex; flex-direction:column; gap:8px;"></div>

        <h4 style="margin:12px 0 8px 0; color:var(--neon)">Perfis com interesses semelhantes</h4>
        <div id="modalRecommendations" style="display:flex; flex-direction:column; gap:8px; max-height:180px; overflow:auto;"></div>
      </aside>
    </div>
  </div>

  <script>
/* Consolidated script ‚Äî safe, single-definition, ordered */

// authentication handling: prefer localStorage.usuario, fallback to Firebase Auth (wait a short per√≠odo).
// Evita redirect imediato que impedia Firebase Auth de preencher o usu√°rio quando presente.
async function ensureLoggedInOrRedirect() {
  if (localStorage.getItem("usuario")) return true;
  if (typeof firebase !== 'undefined' && firebase.auth) {
    // espera at√© 1.5s por onAuthStateChanged
    let resolved = false;
    const p = new Promise(resolve => {
      const unsub = firebase.auth().onAuthStateChanged(user => {
        if (user) {
          const name = user.displayName || user.email || user.uid;
          try { localStorage.setItem('usuario', name); } catch(e){}
          resolved = true;
          try { unsub(); } catch(e){}
          return resolve(true);
        }
      });
      setTimeout(() => { if (!resolved) { try { unsub(); } catch(e){} resolve(false); } }, 1500);
    });
    const ok = await p;
    if (ok) return true;
  }
  // fallback redirect to login
  window.location.href = "login.html";
  return false;
}

const firebaseConfig = {
   apiKey: "AIzaSyAVZ-dvyJuGFF4fEHGjS-TrhzBmBslVwNs",
   authDomain: "curso-3-inteligencia-emocional.firebaseapp.com",
   projectId: "curso-3-inteligencia-emocional",
   storageBucket: "curso-3-inteligencia-emocional.appspot.com",
   messagingSenderId: "105031303963",
   appId: "1:105031303963:web:0ecdcddc91fbb0af69c9be"
 };
 firebase.initializeApp(firebaseConfig);
 const db = firebase.firestore();
 
const nomeUsuario = localStorage.getItem("usuario");
const defaultAvatar = localStorage.getItem('avatar') || 'img/img1.png';

/* novo: debounce timeout usado pela busca */
let _searchTimeout = null;

/* ---------- Utilities ---------- */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
function truncate(text, maxLen = 80) {
  if (text === null || text === undefined) return '';
  const s = String(text);
  return s.length > maxLen ? s.slice(0, maxLen - 1) + '‚Ä¶' : s;
}
function calcLevel(xp = 0) {
  const level = Math.floor(xp / 100) + 1;
  const progress = xp % 100;
  return { level, progress, next: 100 };
}
function showToast(text, timeout = 2200) {
  const t = document.createElement('div');
  t.textContent = text;
  t.style.position = 'fixed';
  t.style.right = '18px';
  t.style.bottom = '18px';
  t.style.background = 'linear-gradient(90deg, rgba(0,255,156,0.12), rgba(0,200,140,0.06))';
  t.style.border = '1px solid rgba(0,255,156,0.14)';
  t.style.color = '#00ffd0';
  t.style.padding = '10px 14px';
  t.style.borderRadius = '10px';
  t.style.zIndex = 9999;
  t.style.boxShadow = '0 10px 30px rgba(0,255,156,0.04)';
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity = '0.0', timeout - 300);
  setTimeout(()=> t.remove(), timeout);
}

/* ---------- ADICIONADO: addActivity (grava atividade e atualiza feed) ---------- */
function addActivity(text, meta = {}) {
  try {
    if (!text || typeof text !== 'string') return Promise.resolve(null);
    if (typeof db === 'undefined' || !db) return Promise.resolve(null);
    const payload = {
      text: String(text).slice(0, 800),
      actor: nomeUsuario || null,
      meta: (typeof meta === 'object' && meta) ? meta : {},
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    // grava em activities (principal) e em atividades (legacy) ‚Äî n√£o aguardar ambos para n√£o bloquear
    return db.collection('activities').add(payload)
      .then((ref) => {
        // tentativa paralela de gravar no fallback (n√£o √© cr√≠tica)
        try { db.collection('atividades').add(payload).catch(()=>{}); } catch(e){}
        // tentar atualizar feed localmente para maior responsividade
        try { if (typeof loadActivity === 'function') loadActivity().catch(()=>{}); } catch(e){}
        return ref;
      })
      .catch(err => {
        console.warn('addActivity write failed', err);
        // ainda tentar fallback
        try { db.collection('atividades').add(payload).catch(()=>{}); } catch(e){}
        try { if (typeof loadActivity === 'function') loadActivity().catch(()=>{}); } catch(e){}
        return null;
      });
  } catch (e) {
    console.warn('addActivity error', e);
    return Promise.resolve(null);
  }
}

/* ---------- User doc / profile ---------- */
async function ensureUserDoc() {
  try {
    const q = await db.collection("usuarios").where("nome", "==", nomeUsuario).limit(1).get();
    if (!q.empty) return q.docs[0];
    const newDocRef = await db.collection("usuarios").add({
      nome: nomeUsuario,
      avatar: defaultAvatar,
      xp: 0,
      streak: 0,
      badges: [],
      followers: [],
      following: [],
      followersIds: [],
      followingIds: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return await newDocRef.get();
  } catch (e) {
    console.error("Erro ensureUserDoc:", e);
    return null;
  }
}

/* ---------- Achievements ---------- */
async function revealAchievement(id) {
  try {
    if (!id || !db || !nomeUsuario) return;
    const q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    if (q.empty) return;
    const doc = q.docs[0];
    const data = doc.data() || {};
    const badges = Array.isArray(data.badges) ? data.badges : [];
    if (badges.find(b => b.id === id)) return;
    const badge = { id, title: id, img: `img/${id}.png`, earnedAt: firebase.firestore.FieldValue.serverTimestamp() };
    await doc.ref.update({ badges: firebase.firestore.FieldValue.arrayUnion(badge) });
    try { await addActivity(`${nomeUsuario} desbloqueou: ${id}`); } catch(e){}
    try { showToast(`Conquista desbloqueada: ${id}`); } catch(e){}
    if (typeof renderAchievements === 'function') renderAchievements();
  } catch (e) {
    console.error('revealAchievement error', e);
  }
}

async function renderAchievements() {
  try {
    const modal = document.getElementById('achievementsModal');
    if (!modal) return;
    const grid = modal.querySelector('.ach-grid');
    if (!grid) return;
    grid.innerHTML = 'Carregando...';

    const FALLBACK = {
      ach_post: { id: 'ach_post', title: 'Primeiro Post', hint: 'Publicou no feed.', img: 'img/ach_post.png' },
      ach_like: { id: 'ach_like', title: 'Curtiu', hint: 'Curtiu um post.', img: 'img/ach_like.png' },
      ach_comment: { id: 'ach_comment', title: 'Comentou', hint: 'Comentou em um post.', img: 'img/ach_comment.png' }
    };
    const LIST = (typeof ACH_LIST === 'object' && ACH_LIST) ? ACH_LIST : FALLBACK;

    function parseTimestamp(raw) {
      if (!raw) return null;
      if (raw && typeof raw.toDate === 'function') return raw.toDate();
      if (raw && typeof raw.seconds === 'number') return new Date(raw.seconds * 1000);
      if (typeof raw === 'string') { const d = new Date(raw); if (!isNaN(d)) return d; }
      if (typeof raw === 'number') return new Date(raw);
      return null;
    }

    const q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const data = q.empty ? {} : q.docs[0].data();
    const badges = Array.isArray(data.badges) ? data.badges : [];

    grid.innerHTML = '';
    Object.values(LIST).forEach(meta => {
      const a = meta || {};
      const unlocked = badges.find(b => String(b.id || b.name || b.title) === String(a.id));
      const card = document.createElement('div');
      card.className = 'ach-item-card';
      card.style.display = 'inline-block';
      card.style.width = '160px';
      card.style.margin = '8px';
      card.style.textAlign = 'center';
      card.style.padding = '10px';
      card.style.borderRadius = '10px';
      card.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.08), rgba(0,0,0,0.02))';
      const imgSrc = a.img || 'img/ach_placeholder.png';

      let dateStr = '<span class="muted">' + (a.hint || '') + '</span>';
      if (unlocked) {
        const raw = unlocked.earnedAt || unlocked.ts || unlocked.time || unlocked.date || null;
        const d = parseTimestamp(raw);
        dateStr = d ? ('Conquistada: ' + d.toLocaleString()) : 'Conquistada';
      }

      card.innerHTML = `
        <div style="width:96px;height:96px;margin:0 auto 8px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;border:2px solid rgba(0,255,156,0.06);background:rgba(0,0,0,0.06)">
          <img src="${imgSrc}" alt="${escapeHtml(a.title || '')}" style="width:84px;height:84px;object-fit:cover;filter:${unlocked ? 'none' : 'grayscale(100%) brightness(.6)'}" />
        </div>
        <div style="font-weight:700;color:var(--neon)">${escapeHtml(a.title || a.id)}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">${dateStr}</div>
      `;
      grid.appendChild(card);
    });
  } catch (e) {
    console.error('renderAchievements error', e);
    try { const grid = document.querySelector('#achievementsModal .ach-grid'); if (grid) grid.innerHTML = 'Erro ao carregar conquistas'; } catch(e){}
  }
}

/* ---------- Profile modal enhancements: tags, edi√ß√£o e recomenda√ß√µes ---------- */

function renderTagChip(tag, removable = false) {
  const chip = document.createElement('div');
  chip.className = 'tag-chip';
  chip.style.padding = '6px 10px';
  chip.style.borderRadius = '999px';
  chip.style.border = '1px solid rgba(0,255,156,0.12)';
  chip.style.background = 'linear-gradient(90deg, rgba(0,255,156,0.02), rgba(0,255,156,0.01))';
  chip.style.color = 'var(--neon)';
  chip.style.fontSize = '13px';
  chip.style.display = 'inline-flex';
  chip.style.alignItems = 'center';
  chip.style.gap = '8px';
  chip.style.boxShadow = '0 6px 18px rgba(0,255,156,0.03)';
  chip.textContent = tag;
  if (removable) {
    const x = document.createElement('button');
    x.textContent = '‚úï';
    x.title = 'Remover tag';
    x.style.background = 'transparent';
    x.style.border = 'none';
    x.style.cursor = 'pointer';
    x.style.color = 'rgba(255,255,255,0.6)';
    x.onclick = (e) => { e.stopPropagation(); chip.remove(); };
    chip.appendChild(x);
  }
  return chip;
}

async function recommendSimilarUsers(tags = [], limit = 6) {
  try {
    const out = [];
    if (!db) return out;
    if (!Array.isArray(tags) || tags.length === 0) return out;
    // Firestore supports array-contains-any up to 10 elements
    const qTags = tags.slice(0, 10);
    const snap = await db.collection('usuarios').where('tags', 'array-contains-any', qTags).limit(24).get().catch(()=>null);
    if (!snap || snap.empty) return out;
    const me = nomeUsuario;
    snap.forEach(doc => {
      const d = doc.data() || {};
      if (!d || !d.nome || d.nome === me) return;
      const common = Array.isArray(d.tags) ? d.tags.filter(t => tags.includes(t)) : [];
      out.push({ id: doc.id, nome: d.nome, avatar: d.avatar || defaultAvatar, tags: d.tags || [], common: common.length });
    });
    out.sort((a,b) => b.common - a.common);
    return out.slice(0, limit);
  } catch (e) { console.warn('recommendSimilarUsers', e); return []; }
}

async function saveProfileEdits(targetDocRef, payload) {
  try {
    if (!targetDocRef || !db) return false;
    // normalize tags: ensure array of strings
    if (payload.tags && !Array.isArray(payload.tags)) {
      payload.tags = Array.from(payload.tags);
    }
    await targetDocRef.update(payload);

    // if current user changed their own nome, persist and reload to keep app consistent
    try {
      const currentName = nomeUsuario;
      if (payload.nome && payload.nome !== currentName) {
        try { localStorage.setItem('usuario', payload.nome); } catch(e){}
        // reload to ensure all state keys refresh (nomeUsuario √© const no script)
        window.location.reload();
        return true;
      }
    } catch(e){ console.warn('saveProfileEdits name-sync', e); }

    // otherwise just refresh UI
    await loadProfileInternal().catch(()=>{});
    showToast('Perfil salvo');
    return true;
  } catch (e) { console.error('saveProfileEdits', e); return false; }
}

// override openProfileModal with enhanced version
window.openProfileModal = async function(targetName){
  try {
    if (!targetName) return;
    const modal = document.getElementById('profileModal');
    if (!modal) return;
    const nameEl = document.getElementById('modalName');
    const typeEl = document.getElementById('modalMeta');
    const bioEl  = document.getElementById('modalBio');
    const avatarEl = document.getElementById('modalAvatar');
    const bannerEl = document.getElementById('modalBanner');
    const followBtn = document.getElementById('modalFollowBtn');
    const editBtn = document.getElementById('modalEditBtn');
    const editArea = document.getElementById('modalEditArea');
    const editTagsList = document.getElementById('editTagsList');
    const modalTags = document.getElementById('modalTags');
    const modalAffinity = document.getElementById('modalAffinity');
    const modalStats = document.getElementById('modalStats');
    const modalActivities = document.getElementById('modalActivities');
    const modalRecommendations = document.getElementById('modalRecommendations');

    // reset
    nameEl.textContent = ''; typeEl.textContent=''; bioEl.textContent=''; avatarEl.src = defaultAvatar;
    modalTags.innerHTML = ''; modalActivities.innerHTML = ''; modalRecommendations.innerHTML = ''; modalStats.innerHTML=''; modalAffinity.textContent='';

    // load target user
    const snap = await db.collection('usuarios').where('nome','==',targetName).limit(1).get();
    if (snap.empty) {
      nameEl.textContent = targetName;
      bioEl.textContent = 'Usu√°rio n√£o encontrado.';
      followBtn.style.display = 'none';
      editBtn.style.display = 'none';
      modal.classList.remove('hidden');
      return;
    }
    const doc = snap.docs[0]; const d = doc.data() || {};
    nameEl.textContent = d.nome || targetName;
    bioEl.textContent = d.bio || d.descricao || '';
    avatarEl.src = d.avatar || defaultAvatar;
    // banner: if banner URL present, set background
    if (d.banner) bannerEl.style.backgroundImage = `url('${d.banner}')`, bannerEl.style.backgroundSize='cover', bannerEl.style.backgroundPosition='center';
    else bannerEl.style.background = 'linear-gradient(90deg, rgba(0,255,156,0.06), rgba(0,255,156,0.02))';

    // stats
    modalStats.innerHTML = `XP: <strong style="color:var(--neon)">${Number(d.xp||0)}</strong><br/>N√≠vel: <strong style="color:var(--neon)">${Number(d.nivel||calcLevel(d.xp||0).level)}</strong><br/>Streak: <strong style="color:var(--neon)">${Number(d.streak||0)} dias</strong><br/>Seguidores: <strong style="color:var(--neon)">${(d.followers||[]).length}</strong> ‚Ä¢ Seguindo: <strong style="color:var(--neon)">${(d.following||[]).length}</strong>`;

    // render tags (read-only)
    const tags = Array.isArray(d.tags) ? d.tags : [];
    modalTags.innerHTML = '';
    if (tags.length === 0) modalTags.innerHTML = '<div class="small muted">Sem interesses declarados.</div>';
    else tags.forEach(t => modalTags.appendChild(renderTagChip(t, false)));

    // affinity: compare with current user tags
    try {
      const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
      const meData = meSnap.empty ? {} : meSnap.docs[0].data();
      const myTags = Array.isArray(meData.tags) ? meData.tags : [];
      const common = myTags.filter(x => tags.includes(x));
      if (myTags.length && tags.length) modalAffinity.textContent = `${common.length} interesses em comum`;
    } catch(e){}

    // follow/edit button logic
    const meSnap2 = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const meData2 = meSnap2.empty ? {} : meSnap2.docs[0].data();
    const isMe = (d.nome === nomeUsuario);
    if (isMe) {
      followBtn.style.display = 'none';
      editBtn.style.display = 'inline-block';
      editBtn.onclick = () => {
        // enter edit mode
        document.getElementById('editName').value = d.nome || nomeUsuario;
        document.getElementById('editBio').value = d.bio || '';
        document.getElementById('editBanner').value = d.banner || '';
        editTagsList.innerHTML = '';
        (Array.isArray(d.tags) ? d.tags : []).forEach(t => editTagsList.appendChild(renderTagChip(t, true)));
        editArea.style.display = 'block';
        editBtn.style.display = 'none';
      };
      // wire save/cancel
      document.getElementById('cancelEditBtn').onclick = () => { editArea.style.display = 'none'; editBtn.style.display = 'inline-block'; };
      document.getElementById('addTagBtn').onclick = () => {
        const v = (document.getElementById('newTagInput').value || '').trim();
        if (!v) return;
        editTagsList.appendChild(renderTagChip(v, true));
        document.getElementById('newTagInput').value = '';
      };
      document.getElementById('saveEditBtn').onclick = async () => {
        const newName = (document.getElementById('editName').value || '').trim();
        const newBio = (document.getElementById('editBio').value || '').trim();
        const newBanner = (document.getElementById('editBanner').value || '').trim();
        const tagsEls = Array.from(editTagsList.children).map(n => n.childNodes && n.childNodes.length ? n.childNodes[0].textContent : n.textContent).filter(Boolean);
        const payload = { nome: newName || d.nome, bio: newBio, banner: newBanner, tags: tagsEls, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
        const docRef = doc.ref;
        const ok = await saveProfileEdits(docRef, payload);
        if (ok) { editArea.style.display = 'none'; editBtn.style.display = 'inline-block'; }
      };
    } else {
      editBtn.style.display = 'none';
      const isFollowing = Array.isArray(meData2.following) ? meData2.following.includes(d.nome) : false;
      followBtn.textContent = isFollowing ? 'Seguindo' : 'Seguir';
      followBtn.onclick = async () => {
        try {
          if (followBtn.textContent.trim() === 'Seguindo') {
            await unfollowUser(d.nome, doc.id);
            followBtn.textContent = 'Seguir';
          } else {
            await followUser(d.nome, doc.id);
            followBtn.textContent = 'Seguindo';
          }
          // atualizar recomenda√ß√µes e lista de amigos
          loadFriendsList().catch(()=>{}); loadUserSuggestions().catch(()=>{});
        } catch(e){ console.warn(e); }
      };
    }

    // activities by this user
    try {
      modalActivities.innerHTML = 'Carregando...';
      const actsSnap = await db.collection('activities').where('actor','==',d.nome).orderBy('createdAt','desc').limit(12).get().catch(()=>null);
      modalActivities.innerHTML = '';
      if (actsSnap && !actsSnap.empty) {
        actsSnap.forEach(aDoc => {
          const a = aDoc.data() || {};
          const ts = (a.createdAt && typeof a.createdAt.toDate === 'function') ? a.createdAt.toDate().toLocaleDateString() : new Date().toLocaleDateString();
          const row = document.createElement('div');
          row.style.fontSize='13px'; row.style.color='var(--muted)'; row.style.padding='6px';
          row.textContent = `${a.text || 'Atividade'} ‚Ä¢ ${ts}`;
          modalActivities.appendChild(row);
        });
      } else {
        modalActivities.innerHTML = '<div class="small muted">Sem atividades recentes.</div>';
      }
    } catch(e){ modalActivities.innerHTML = '<div class="small muted">Erro ao carregar atividades.</div>'; }

    // recommendations
    try {
      modalRecommendations.innerHTML = 'Carregando...';
      const recs = await recommendSimilarUsers(tags, 6);
      modalRecommendations.innerHTML = '';
      if (!recs || recs.length === 0) modalRecommendations.innerHTML = '<div class="small muted">Sem recomenda√ß√µes.</div>';
      else {
        recs.forEach(r => {
          const row = document.createElement('div');
          row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px'; row.style.gap='8px';
          row.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${escapeHtml(r.avatar)}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid rgba(0,255,156,0.04)"/><div><div style="font-weight:700;color:var(--neon)">${escapeHtml(r.nome)}</div><div class="muted" style="font-size:12px">${r.common} interesses em comum</div></div></div><div><button class="btn" onclick="openProfileModal('${escapeHtml(r.nome)}')">Abrir</button></div>`;
          modalRecommendations.appendChild(row);
        });
      }
    } catch(e){ modalRecommendations.innerHTML = '<div class="small muted">Erro ao carregar recomenda√ß√µes.</div>'; }

    modal.classList.remove('hidden');
  } catch (e) {
    console.error('openProfileModal (enhanced) error', e);
    alert('Erro ao abrir perfil.');
  }
};
window.closeProfileModal = function(){ const modal = document.getElementById('profileModal'); if (modal) modal.classList.add('hidden'); };

/* ---------- Follow / Unfollow ---------- */
async function followUser(targetName, targetId = null) {
  if (!targetName || targetName === nomeUsuario) return;
  try {
    const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const meDoc = meSnap.empty ? null : meSnap.docs[0];
    const targetRef = targetId ? db.collection('usuarios').doc(targetId) : (await db.collection('usuarios').where('nome','==',targetName).limit(1).get()).docs[0]?.ref;
    if (!meDoc || !targetRef) return;
    const meRef = meDoc.ref;

    await db.runTransaction(async tx => {
      const [mSnap, tSnap] = await Promise.all([tx.get(meRef), tx.get(targetRef)]);
      if (!mSnap.exists || !tSnap.exists) return;
      const mData = mSnap.data() || {};
      const tData = tSnap.data() || {};
      if ((mData.following || []).includes(tData.nome) || (mData.followingIds || []).includes(targetRef.id)) return;
      tx.update(meRef, {
        following: firebase.firestore.FieldValue.arrayUnion(tData.nome),
        followingIds: firebase.firestore.FieldValue.arrayUnion(targetRef.id),
        followingCount: firebase.firestore.FieldValue.increment(1)
      });
      tx.update(targetRef, {
        followers: firebase.firestore.FieldValue.arrayUnion(nomeUsuario),
        followersIds: firebase.firestore.FieldValue.arrayUnion(meRef.id),
        followersCount: firebase.firestore.FieldValue.increment(1)
      });
    });

    try { await addActivity(`${nomeUsuario} come√ßou a seguir ${targetName}`); } catch(e){}
    try {
      await db.collection('notifications').add({
        to: targetName,
        from: nomeUsuario,
        type: 'follow',
        text: `${nomeUsuario} come√ßou a seguir voc√™`,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        read: false
      });
    } catch(e){}
    try { if (typeof loadUsersList === 'function') await loadUsersList(); } catch(e){}
    try { if (typeof loadFriendsList === 'function') await loadFriendsList(); } catch(e){}
    try { showToast('Seguindo ' + targetName); } catch(e){}
  } catch (e) {
    console.error('followUser error', e);
  }
}
async function unfollowUser(targetName, targetId = null) {
  if (!targetName || targetName === nomeUsuario) return;
  try {
    const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const meDoc = meSnap.empty ? null : meSnap.docs[0];
    const targetRef = targetId ? db.collection('usuarios').doc(targetId) : (await db.collection('usuarios').where('nome','==',targetName).limit(1).get()).docs[0]?.ref;
    if (!meDoc || !targetRef) return;
    const meRef = meDoc.ref;

    await db.runTransaction(async tx => {
      const [mSnap, tSnap] = await Promise.all([tx.get(meRef), tx.get(targetRef)]);
      if (!mSnap.exists || !tSnap.exists) return;
      const tData = tSnap.data() || {};
      tx.update(meRef, {
        following: firebase.firestore.FieldValue.arrayRemove(tData.nome),
        followingIds: firebase.firestore.FieldValue.arrayRemove(targetRef.id),
        followingCount: firebase.firestore.FieldValue.increment(-1)
      });
      tx.update(targetRef, {
        followers: firebase.firestore.FieldValue.arrayRemove(nomeUsuario),
        followersIds: firebase.firestore.FieldValue.arrayRemove(meRef.id),
        followersCount: firebase.firestore.FieldValue.increment(-1)
      });
    });

    try { await addActivity(`${nomeUsuario} deixou de seguir ${targetName}`); } catch(e){}
    try { if (typeof loadUsersList === 'function') await loadUsersList(); } catch(e){}
    try { if (typeof loadFriendsList === 'function') await loadFriendsList(); } catch(e){}
    try { showToast('Deixou de seguir ' + targetName); } catch(e){}
  } catch (e) {
    console.error('unfollowUser error', e);
  }
}

/* ---------- Users UI: suggestions (limited) and full list (searchable) ---------- */
async function loadUserSuggestions() {
  const suggestionsEl = document.getElementById('user-suggestions');
  if (!suggestionsEl) return;
  suggestionsEl.innerHTML = 'Carregando...';
  try {
    const me = nomeUsuario;
    const snap = await db.collection('usuarios').orderBy('followersCount','desc').limit(20).get();
    const candidates = [];
    snap.forEach(doc => {
      const u = doc.data();
      if (!u || !u.nome) return;
      if (u.nome === me) return;
      candidates.push({ id: doc.id, ...u });
    });
    // show a small number of recommended profiles
    const top = candidates.slice(0,4);
    suggestionsEl.innerHTML = '';
    top.forEach(u => {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.gap = '8px';
      row.style.padding = '6px 8px';
      row.style.border = '1px solid rgba(0,255,156,0.06)';
      row.style.borderRadius = '10px';
      row.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01))';
      row.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px">
          <img src="${u.avatar || defaultAvatar}" style="width:44px;height:44px;border-radius:50%;border:2px solid #00ff9c;object-fit:cover"/>
          <div>
            <div style="font-weight:700;color:#00ff9c">${escapeHtml(u.nome)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(u.tipo || 'perfil recomendado')}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="openProfileModal('${escapeHtml(u.nome)}')">Perfil</button>
          <button class="btn followBtn" data-name="${escapeHtml(u.nome)}" data-id="${u.id}">Seguir</button>
        </div>
      `;
      suggestionsEl.appendChild(row);
    });
    Array.from(suggestionsEl.querySelectorAll('.followBtn')).forEach(b => {
      b.removeEventListener('click', b._handler);
      b._handler = async function(e){
        const name = e.currentTarget.dataset.name;
        const id = e.currentTarget.dataset.id;
        // toggle
        const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        const meData = meSnap.empty ? {} : meSnap.docs[0].data();
        const isFollowing = Array.isArray(meData.following) ? meData.following.includes(name) : false;
        if (isFollowing) await unfollowUser(name, id);
        else await followUser(name, id);
        loadUserSuggestions().catch(()=>{});
        loadFriendsList().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });
  } catch (err) {
    console.error('loadUserSuggestions error', err);
    suggestionsEl.innerHTML = 'Erro ao carregar perfis recomendados.';
  }
}

async function loadUsersList(filter = '') {
  const container = document.getElementById('usersList');
  if (!container) return;
  container.innerHTML = 'Carregando...';
  try {
    const snap = await db.collection('usuarios').orderBy('nome').get();
    const me = nomeUsuario;
    container.innerHTML = '';
    snap.forEach(doc => {
      const u = doc.data();
      if (!u || !u.nome) return;
      if (u.nome === me) return;
      if (filter && !u.nome.toLowerCase().includes(filter.toLowerCase())) return;
      const card = document.createElement('div');
      card.className = 'card';
      card.style.padding = '8px';

      // show follow state correctly based on current user's following list
      card.innerHTML = (function(){
        const nameEsc = escapeHtml(u.nome);
        return `
         <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
           <div style="display:flex;align-items:center;gap:8px">
             <img src="${u.avatar || defaultAvatar}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid #00ff9c">
             <div>
               <div style="font-weight:700;color:#00ff9c">${escapeHtml(u.nome)}</div>
               <div class="muted" style="font-size:12px">${escapeHtml(u.tipo || '')}</div>
             </div>
           </div>
           <div style="display:flex;gap:8px">
             <button class="btn" onclick="openProfileModal('${nameEsc}')">Perfil</button>
             <button class="btn followBtn" data-name="${nameEsc}" data-id="${doc.id}">Seguir</button>
           </div>
         </div>
       `;
      })();
      container.appendChild(card);
    });
    Array.from(container.querySelectorAll('.followBtn')).forEach(b => {
      b.removeEventListener('click', b._handler);
      b._handler = async function(e){
        const name = e.currentTarget.dataset.name;
        const id = e.currentTarget.dataset.id;
        const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        const meData = meSnap.empty ? {} : meSnap.docs[0].data();
        const isFollowing = Array.isArray(meData.following) ? meData.following.includes(name) : false;
        if (isFollowing) await unfollowUser(name, id);
        else await followUser(name, id);
        loadUserSuggestions().catch(()=>{});
        loadFriendsList().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });
  } catch (err) {
    console.error('loadUsersList error', err);
    container.innerHTML = 'Erro ao carregar usu√°rios.';
  }
}

/* ---------- Search users (Firestore prefix search) ---------- */

async function searchUsers(q = '') {
  const container = document.getElementById('usersList');
  if (!container) return;
  const query = String(q || '').trim();
  if (!query) {
    container.innerHTML = '<div class="small muted">Digite ao menos 1 caractere para buscar. Resultado n√£o inclui quem voc√™ j√° segue.</div>';
    return;
  }
  container.innerHTML = 'Buscando...';
  try {
    // obter lista de quem eu sigo para filtrar resultados e evitar duplica√ß√£o
    const meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    const meData = meSnap.empty ? {} : meSnap.docs[0].data();
    const following = Array.isArray(meData.following) ? meData.following : [];

    // Firestore prefix search (ordenar por nome)
    const snap = await db.collection('usuarios')
      .orderBy('nome')
      .startAt(query)
      .endAt(query + '\uf8ff')
      .limit(40)
      .get();

    container.innerHTML = '';
    if (snap.empty) {
      container.innerHTML = '<div class="small muted">Nenhum usu√°rio encontrado.</div>';
      return;
    }

    let shown = 0;
    snap.forEach(doc => {
      const d = doc.data() || {};
      if (!d || !d.nome) return;
      // filtrar quem j√° sigo (evita duplica√ß√£o entre busca e lista "Seguindo")
      if (following.includes(d.nome)) return;
      const card = renderUserCard(d, doc.id);
      container.appendChild(card);
      shown++;
    });

    if (shown === 0) {
      container.innerHTML = '<div class="small muted">Nenhum resultado (os usu√°rios j√° seguidos s√£o ocultos).</div>';
      return;
    }

    // wiring follow buttons in results
    Array.from(container.querySelectorAll('.followBtn')).forEach(b => {
      b.removeEventListener('click', b._handler);
      b._handler = async function(e){
        const name = e.currentTarget.dataset.name;
        const id = e.currentTarget.dataset.id;
        const meSnap2 = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        const meData2 = meSnap2.empty ? {} : meSnap2.docs[0].data();
        const isFollowing = Array.isArray(meData2.following) ? meData2.following.includes(name) : false;
        if (isFollowing) {
          await unfollowUser(name, id);
        } else {
          await followUser(name, id);
        }
        // reexecutar busca atual e atualizar lista de amigos
        searchUsers(document.getElementById('search-user').value.trim()).catch(()=>{});
        loadFriendsList().catch(()=>{});
        loadUserSuggestions().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });

  } catch (err) {
    console.error('searchUsers error', err);
    container.innerHTML = '<div class="small muted">Erro ao pesquisar usu√°rios.</div>';
  }
}

// debounce wiring
const searchInputEl = document.getElementById('search-user');
const searchBtn = document.getElementById('search-btn');
if (searchInputEl) {
  searchInputEl.addEventListener('input', (e) => {
    clearTimeout(_searchTimeout);
    _searchTimeout = setTimeout(() => {
      searchUsers(e.target.value);
    }, 250);
  });
}
if (searchBtn) {
  searchBtn.addEventListener('click', () => {
    const v = (document.getElementById('search-user') || {}).value || '';
    searchUsers(v);
    // scroll to results
    const el = document.getElementById('usersList');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });
}

// fallback: when page loads, show small hint in usersList and populate recommendations
document.addEventListener('DOMContentLoaded', () => {
  const ul = document.getElementById('usersList');
  if (ul) ul.innerHTML = '<div class="muted small">Busque por nomes de usu√°rios. Resultados aparecem aqui.</div>';
});

/* ---------- Feed, posts, comments, likes (restoration) ---------- */

// realtime subscriptions
let _postsUnsub = null;
let _commentUnsubs = {}; // map postId -> unsubscribe fn
// ADICIONADO: atividade realtime
let _activitiesUnsubActivities = null;
let _activitiesUnsubAtividades = null;

function watchActivitiesRealtime() {
  try {
    if (!db) return;
    // limpa listeners anteriores com prote√ß√µes
    try {
      if (_activitiesUnsubActivities) { try { _activitiesUnsubActivities(); } catch(e){} _activitiesUnsubActivities = null; }
    } catch(e){ console.warn('clear _activitiesUnsubActivities', e); }

    try {
      if (_activitiesUnsubAtividades) { try { _activitiesUnsubAtividades(); } catch(e){} _activitiesUnsubAtividades = null; }
    } catch(e){ console.warn('clear _activitiesUnsubAtividades', e); }

    // listener principal: collection "activities"
    try {
      _activitiesUnsubActivities = db.collection('activities').orderBy('createdAt','desc').limit(50)
        .onSnapshot(() => {
          if (typeof loadActivity === 'function') loadActivity().catch(()=>{});
        }, err => console.warn('activities onSnapshot error', err));
    } catch(e){ console.warn('watch activities (activities) failed', e); }

    // fallback / legacy: collection "atividades"
    try {
      _activitiesUnsubAtividades = db.collection('atividades').orderBy('createdAt','desc').limit(50)
        .onSnapshot(() => {
          if (typeof loadActivity === 'function') loadActivity().catch(()=>{});
        }, err => console.warn('activities (atividades) onSnapshot error', err));
    } catch(e){ console.warn('watch activities (atividades) failed', e); }

  } catch (e) {
    console.warn('watchActivitiesRealtime error', e);
  }
}

// start watching posts collection and trigger loadFeed on changes
function watchPostsRealtime() {
  try {
    if (!db) return;
    if (_postsUnsub) { try { _postsUnsub(); } catch(e){} _postsUnsub = null; }
    _postsUnsub = db.collection('posts').orderBy('createdAt','desc').limit(100)
      .onSnapshot(() => {
        if (typeof loadFeed === 'function') loadFeed().catch(()=>{});
      }, err => console.warn('posts onSnapshot error', err));
  } catch (e) { console.warn('watchPostsRealtime error', e); }
}

// load feed (renders posts, like/comment/share UI)
async function loadFeed() {
  try {
    const feedEl = document.getElementById('feed');
    if (!feedEl) return;
    feedEl.innerHTML = '<div style="opacity:.6">Carregando...</div>';
    if (!db) { feedEl.innerHTML = '<div class="muted">Offline</div>'; return; }
    const snapshot = await db.collection('posts').orderBy('createdAt','desc').limit(100).get();
    feedEl.innerHTML = '';

    // mostrar todos os posts retornados (sem filtro de 24h)
    for (const doc of snapshot.docs) {
      const p = doc.data() || {};

      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.setAttribute('data-postid', doc.id);
      postEl.style.padding = '12px';
      postEl.style.marginBottom = '10px';
      postEl.style.borderRadius = '10px';
      postEl.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01))';

      // header
      const header = document.createElement('div'); header.className = 'post-top'; header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
      const left = document.createElement('div'); left.className='meta'; left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
      const avatar = document.createElement('img'); avatar.className='post-avatar'; avatar.src = p.avatar || defaultAvatar; avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='50%'; avatar.style.objectFit='cover'; avatar.style.border='1px solid rgba(0,255,156,0.06)';
      const authorWrap = document.createElement('div');
      const nameEl = document.createElement('strong'); nameEl.textContent = p.author || 'Usu√°rio';

      // apenas data (sem hora/minuto) ‚Äî fallback para when createdAt missing
      let dateText = '';
      if (p.createdAt && typeof p.createdAt.toDate === 'function') {
        dateText = p.createdAt.toDate().toLocaleDateString();
      } else if (p.createdAt && typeof p.createdAt.seconds === 'number') {
        dateText = new Date(p.createdAt.seconds * 1000).toLocaleDateString();
      } else {
        dateText = new Date().toLocaleDateString();
      }
      const dateEl = document.createElement('div'); dateEl.className='muted'; dateEl.style.fontSize='12px'; dateEl.textContent = dateText;

      authorWrap.appendChild(nameEl); authorWrap.appendChild(dateEl);
      left.appendChild(avatar); left.appendChild(authorWrap);

      const actionsTop = document.createElement('div');
      const pokeBtn = document.createElement('button'); pokeBtn.className='btn'; pokeBtn.textContent='Cutucar'; pokeBtn.onclick = () => pokeUser(p.author);
      actionsTop.appendChild(pokeBtn);

      header.appendChild(left); header.appendChild(actionsTop);

      // content
      const content = document.createElement('div'); content.className='post-content'; content.style.marginTop='8px';
      content.textContent = p.text || '';

      // bottom actions
      const bottom = document.createElement('div'); bottom.className='post-actions'; bottom.style.display='flex'; bottom.style.gap='8px'; bottom.style.marginTop='10px'; bottom.style.justifyContent='flex-end';
      const likeBtn = document.createElement('button'); likeBtn.className='btn like-btn';
      const likeCount = Number(p.likes || 0);
      likeBtn.innerHTML = `<span class="like-count">${likeCount}</span> Curtir`;
      likeBtn.onclick = async () => { await toggleLike(doc.id, likeBtn); };
      const commentBtn = document.createElement('button'); commentBtn.className='btn comment-btn'; commentBtn.textContent = 'Coment√°rios'; commentBtn.onclick = () => toggleComments(doc.id);
      const shareBtn = document.createElement('button'); shareBtn.className='btn'; shareBtn.textContent = 'Compartilhar'; shareBtn.onclick = () => sharePost(doc.id);
      bottom.appendChild(likeBtn); bottom.appendChild(commentBtn); bottom.appendChild(shareBtn);

      // comments area (hidden by default)
      const commentsWrap = document.createElement('div'); commentsWrap.id = `comments-${doc.id}`; commentsWrap.className='comments-wrap'; commentsWrap.style.display='none'; commentsWrap.style.marginTop='12px';
      const commentsList = document.createElement('div'); commentsList.id = `comments-list-${doc.id}`; commentsList.className='muted comments-list'; commentsList.textContent = 'Carregando coment√°rios...';
      const commentRow = document.createElement('div'); commentRow.className='comment-row'; commentRow.style.display='flex'; commentRow.style.gap='8px'; commentRow.style.marginTop='8px';
      const input = document.createElement('input'); input.id = `comment-input-${doc.id}`; input.placeholder = 'Escreva um coment√°rio...'; input.className='comment-input'; input.style.flex='1'; input.style.padding='8px'; input.style.borderRadius='8px'; input.style.border='1px solid rgba(0,255,156,0.06)'; input.value = '';
      const sendBtn = document.createElement('button'); sendBtn.className='btn comment-send'; sendBtn.textContent='Enviar'; sendBtn.onclick = () => addComment(doc.id);
      commentRow.appendChild(input); commentRow.appendChild(sendBtn);
      commentsWrap.appendChild(commentsList); commentsWrap.appendChild(commentRow);

      postEl.appendChild(header); postEl.appendChild(content); postEl.appendChild(bottom); postEl.appendChild(commentsWrap);
      feedEl.appendChild(postEl);
    }
  } catch (e) {
    console.error('loadFeed error', e);
  }
}

// toggle like using transaction
async function toggleLike(postId, buttonEl) {
  if (!db) return null;
  const postRef = db.collection('posts').doc(postId);
  try {
    const result = await db.runTransaction(async tx => {
      const snap = await tx.get(postRef);
      if (!snap.exists) return null;
      const data = snap.data() || {};
      const likedBy = Array.isArray(data.likedBy) ? data.likedBy.slice() : [];
      let likes = Number(data.likes || 0);
      if (likedBy.includes(nomeUsuario)) {
        const newLikes = Math.max(0, likes - 1);
        tx.update(postRef, { likes: newLikes, likedBy: firebase.firestore.FieldValue.arrayRemove(nomeUsuario) });
        return { action: 'unliked', likes: newLikes };
      } else {
        const newLikes = likes + 1;
        tx.update(postRef, { likes: newLikes, likedBy: firebase.firestore.FieldValue.arrayUnion(nomeUsuario) });
        return { action: 'liked', likes: newLikes };
      }
    });
    if (!result) return null;
    // update UI
    const cnt = result.likes;
    if (buttonEl) {
      const span = buttonEl.querySelector('.like-count');
      if (span) span.textContent = cnt;
      buttonEl.innerHTML = `<span class="like-count">${cnt}</span> Curtir`;
    }
    try { await addActivity(`${nomeUsuario} ${result.action === 'liked' ? 'curtiu' : 'deixou de curtir'} um post`); } catch(e){}
    if (result.action === 'liked') try { revealAchievement('ach_like'); } catch(e){}
    return result.action;
  } catch (e) {
    console.error('toggleLike error', e);
    return null;
  }
}

// NOVO: handler para publicar posts (garante createdAt e recarrega feed)
(function(){
  try {
    const postBtn = document.getElementById('post-btn');
    const postTa  = document.getElementById('post-text');
    if (!postBtn || !postTa) return;
    postBtn.removeEventListener('click', postBtn._handler);
    postBtn._handler = async function(){
      try {
        const text = (postTa.value || '').trim();
        if (!text) { showToast('Escreva algo antes de publicar'); return; }
        if (!db) { showToast('Banco indispon√≠vel'); return; }
        const payload = {
          author: nomeUsuario,
          avatar: localStorage.getItem('avatar') || defaultAvatar,
          text: text,
          likes: 0,
          likedBy: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('posts').add(payload);
        postTa.value = '';
        showToast('Post publicado');
        // tentar recarregar imediatamente (snapshot normalmente far√° isso)
        try { await loadFeed(); } catch(e){ console.warn('loadFeed after publish', e); }
      } catch (e) {
        console.error('publish post error', e);
        showToast('Erro ao publicar post');
      }
    };
    postBtn.addEventListener('click', postBtn._handler);
  } catch(e){ console.warn('post bind error', e); }
})();

// add comment to post (subcollection posts/{id}/comments)
async function addComment(postId) {
  try {
    const input = document.getElementById(`comment-input-${postId}`);
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    const payload = { author: nomeUsuario, avatar: localStorage.getItem('avatar') || defaultAvatar, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() };

    // detecta se j√° existe listener em tempo real para este post
    const hasRealtime = !!_commentUnsubs[postId];

    // adiciona coment√°rio no Firestore
    const docRef = await db.collection('posts').doc(postId).collection('comments').add(payload);
    input.value = '';
    try { await addActivity(`${nomeUsuario} comentou`); } catch(e){}
    try { revealAchievement('ach_comment'); } catch(e){}

    // Se houver listener em tempo real, rely no onSnapshot para atualizar a UI (evita duplica√ß√£o)
    if (hasRealtime) {
      // nada a fazer: onSnapshot vai atualizar a lista
      return docRef;
    }

    // Caso n√£o exista listener, fazemos update otimista e depois garantimos carregar coment√°rios
    const listEl = document.getElementById(`comments-list-${postId}`);
    if (listEl) {
      const item = document.createElement('div'); item.className='comment'; item.style.marginTop='6px';
      item.innerHTML = `<div class="comment-meta" style="display:flex;gap:8px;align-items:center"><img class="comment-avatar" src="${escapeHtml(payload.avatar)}" style="width:28px;height:28px;border-radius:50%"/><strong>${escapeHtml(payload.author)}</strong></div><div class="comment-body">${escapeHtml(payload.text)}</div>`;
      if (listEl.querySelector('.small.muted')) listEl.innerHTML = '';
      listEl.appendChild(item);
      listEl.scrollTop = listEl.scrollHeight;
    }

    // garantir que coment√°rios sejam recarregados (fallback) caso haja atraso no snapshot/consistencia
    setTimeout(()=> loadComments(postId).catch(()=>{}), 700);

    return docRef;
  } catch (e) { console.error('addComment error', e); }
}

async function loadComments(postId) {
  try {
    const listEl = document.getElementById(`comments-list-${postId}`);
    if (!listEl) return;
    listEl.innerHTML = '<div style="opacity:.6">Carregando coment√°rios...</div>';
    const snap = await db.collection('posts').doc(postId).collection('comments').orderBy('createdAt','asc').get();
    listEl.innerHTML = '';
    snap.forEach(doc => {
      const c = doc.data() || {};
      const item = document.createElement('div'); item.className='comment'; item.style.marginTop='6px';
      item.innerHTML = `<div class="comment-meta" style="display:flex;gap:8px;align-items:center"><img class="comment-avatar" src="${escapeHtml(c.avatar || defaultAvatar)}" style="width:28px;height:28px;border-radius:50%"/><strong>${escapeHtml(c.author || 'Usu√°rio')}</strong></div><div class="comment-body">${escapeHtml(c.text || '')}</div>`;
      listEl.appendChild(item);
    });
    if (!snap.size) listEl.innerHTML = '<div class="small muted">Sem coment√°rios ainda.</div>';
  } catch (e) { console.error('loadComments error', e); }
}

function toggleComments(postId) {
  try {
    const wrap = document.getElementById(`comments-${postId}`);
    if (!wrap) return;
    const isHidden = (wrap.style.display === 'none' || wrap.style.display === '');
    if (isHidden) {
      wrap.style.display = 'block';
      // attach realtime listener for comments if not already
      if (_commentUnsubs[postId]) return;
      const ref = db.collection('posts').doc(postId).collection('comments').orderBy('createdAt','asc');
      _commentUnsubs[postId] = ref.onSnapshot(snap => {
        if (!snap) return;
        renderCommentsListFromDocs(postId, snap.docs);
      }, err => console.warn('comments onSnapshot error', err));
    } else {
      wrap.style.display = 'none';
      if (_commentUnsubs[postId]) { try { _commentUnsubs[postId](); } catch(e){} delete _commentUnsubs[postId]; }
    }
  } catch (e) { console.error('toggleComments error', e); }
}

function renderCommentsListFromDocs(postId, docs) {
  try {
    const listEl = document.getElementById(`comments-list-${postId}`);
    if (!listEl) return;
    listEl.innerHTML = '';
    if (!docs || docs.length === 0) { listEl.innerHTML = '<div class="small muted">Sem coment√°rios ainda.</div>'; return; }
    docs.forEach(doc => {
      const c = doc.data() || {};
      const item = document.createElement('div'); item.className='comment'; item.style.marginTop='6px';
      item.innerHTML = `<div class="comment-meta" style="display:flex;gap:8px;align-items:center"><img class="comment-avatar" src="${escapeHtml(c.avatar || defaultAvatar)}" style="width:28px;height:28px;border-radius:50%"/><strong>${escapeHtml(c.author || 'Usu√°rio')}</strong></div><div class="comment-body">${escapeHtml(c.text || '')}</div>`;
      listEl.appendChild(item);
    });
  } catch (e) { console.error('renderCommentsListFromDocs error', e); }
}

// safe poke/share stubs (used by post UI)
window.pokeUser = async function(targetName) {
  try {
    if (!targetName || targetName === nomeUsuario) { showToast('N√£o √© poss√≠vel cutucar voc√™ mesmo'); return; }
    if (db) {
      try { await db.collection('notifications').add({ to: targetName, from: nomeUsuario, type:'poke', text:`${nomeUsuario} cutucou voc√™`, createdAt: firebase.firestore.FieldValue.serverTimestamp(), read:false }); } catch(e){}
    }
    try { await addActivity(`${nomeUsuario} cutucou ${targetName}`); } catch(e){}
    showToast('Cutucada enviada');
  } catch (e) { console.warn('pokeUser', e); }
};

window.sharePost = async function(postId) {
  try {
    if (!postId) return;
    const url = window.location.origin + window.location.pathname + '?post=' + encodeURIComponent(postId);
    try { await navigator.clipboard.writeText(url); showToast('Link copiado'); } catch(e){ showToast('Copiar link falhou'); }
  } catch (e) { console.warn('sharePost', e); }
};

  /* ---------- Initialization (runs last) ---------- */
async function initApp(){
    try {
      await ensureUserDoc();
      // load profile then other parts
      await loadProfileInternal();
      // realtime
      // iniciar escuta em tempo real e tamb√©m carregar feed uma vez para garantir posts vis√≠veis
      try { watchPostsRealtime(); } catch(e){ console.warn('watchPostsRealtime init failed', e); }
      try { watchActivitiesRealtime(); } catch(e){ console.warn('watchActivitiesRealtime init failed', e); }
      try { await loadFeed(); } catch(e){ console.warn('initial loadFeed failed', e); }
      // bind UI
      bindCourseButtons();
      // initial loads ‚Äî n√£o carregar lista completa de usu√°rios automaticamente (evita duplica√ß√£o)
      loadUserSuggestions().catch(()=>{});
      // loadUsersList intentionally NOT called here ‚Äî usersList appears only on search
      loadFriendsList().catch(()=>{});
      loadLeaderboard().catch(()=>{});
      loadActivity().catch(()=>{});
      loadLegacyCourseScores().catch(()=>{});
      loadCourseScores().catch(()=>{}); // tabela de pontua√ß√£o dos cursos
    } catch(e) { console.error('initApp error', e); }
  }

// loadProfileInternal ensures functions are called in right order (called from initApp)
async function loadProfileInternal(){
  try {
    const doc = await ensureUserDoc();
    const data = doc ? doc.data() : {};
    // nome / avatar
    const nameEl = document.getElementById('profile-name');
    const avatarImg = document.getElementById('avatar-img');
    const postAvatar = document.getElementById('post-avatar');
    if (nameEl) nameEl.textContent = data.nome || nomeUsuario;
    if (avatarImg) avatarImg.src = data.avatar || defaultAvatar;
    if (postAvatar) postAvatar.src = data.avatar || defaultAvatar;
    try { localStorage.setItem('avatar', data.avatar || defaultAvatar); } catch(e){}

    // xp / level
    const xp = data.xp || 0;
    const { level, progress, next } = calcLevel(xp);
    const levelEl = document.getElementById('profile-level');
    if (levelEl) levelEl.textContent = 'N√≠vel ' + level;
    const percent = Math.round((progress / next) * 100);
    const xpFill = document.getElementById('xp-fill');
    if (xpFill) xpFill.style.width = percent + '%';
    const xpText = document.getElementById('xp-text');
    if (xpText) xpText.textContent = `${xp} XP ‚Ä¢ ${progress}/${next}`;
    if (typeof updateOrb === 'function') updateOrb(percent);

    // badges
    const badgesWrap = document.getElementById('profile-badges');
    if (badgesWrap) {
      badgesWrap.innerHTML = '';
      const badges = Array.isArray(data.badges) ? data.badges : [];
      if (badges.length === 0) {
        badgesWrap.innerHTML = '<div class="small muted">Sem conquistas ainda.</div>';
      } else {
        badges.forEach(b => {
          try {
            const img = document.createElement('img');
            img.src = (b && b.img) ? b.img : 'img/ach_placeholder.png';
            img.title = (b && b.title) ? b.title : '';
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.objectFit = 'cover';
            img.style.marginRight = '6px';
            img.style.borderRadius = '8px';
            img.style.border = '1px solid rgba(0,255,156,0.06)';
            badgesWrap.appendChild(img);
          } catch(e){}
        });
      }
    }

    // tags (interesses) - sidebar
    const tagsWrap = document.getElementById('profile-tags');
    if (tagsWrap) {
      tagsWrap.innerHTML = '';
      const tags = Array.isArray(data.tags) ? data.tags : [];
      if (!tags.length) {
        tagsWrap.innerHTML = '<div class="small muted">Nenhum interesse declarado.</div>';
      } else {
        tags.forEach(t => {
          try { tagsWrap.appendChild(renderTagChip(t, false)); } catch(e){}
        });
      }
    }

    // tornar nome/avatar clic√°veis para abrir modal de perfil
    try {
      if (avatarImg) {
        avatarImg.style.cursor = 'pointer';
        avatarImg.onclick = function(){ openProfileModal(data.nome || nomeUsuario); };
      }
      if (nameEl) {
        nameEl.style.cursor = 'pointer';
        nameEl.onclick = function(){ openProfileModal(data.nome || nomeUsuario); };
      }
    } catch(e){}

  } catch(e){ console.error('loadProfileInternal', e); }
}

// wire simple UI buttons that exist in markup
document.getElementById('logout-btn').onclick = () => {
  if (firebase.auth) firebase.auth().signOut().catch(()=>{});
  localStorage.clear();
  window.location.href = 'login.html';
};
document.getElementById('edit-profile-btn').onclick = async () => {
  const newName = prompt('Editar nome:', nomeUsuario);
  if (!newName) return;
  const q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
  if (!q.empty) {
    await q.docs[0].ref.update({ nome: newName });
    localStorage.setItem('usuario', newName);
    window.location.reload();
  }
};

// removed duplicate `searchBtn` handler (click is wired above to call searchUsers)
// use the debounced searchUsers() binding declared earlier to handle clicks and Enter

/* ---------- Missing UI bindings & helpers (restoration) ---------- */

/* Mostrar / selecionar avatar (definido cedo para evitar ReferenceError no onclick do HTML) */
window.mostrarOpcoesAvatar = function() {
  try {
    var sel = document.getElementById('selecao-avatar');
    if (!sel) return;
    sel.style.display = (sel.style.display === 'flex') ? 'none' : 'flex';
  } catch (e) { console.warn('mostrarOpcoesAvatar', e); }
};

window.selecionarAvatar = async function(path) {
  try {
    if (!path) return;
    var a = document.getElementById('avatar-img');
    var p = document.getElementById('post-avatar');
    if (a) a.src = path;
    if (p) p.src = path;
    localStorage.setItem('avatar', path);
    // atualizar doc do usu√°rio no Firestore (se dispon√≠vel)
    if (typeof db !== 'undefined' && db) {
      try {
        var q = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
        if (!q.empty) await q.docs[0].ref.update({ avatar: path }).catch(()=>{});
      } catch(e){ console.warn('selecionarAvatar firestore', e); }
    }
    var sel = document.getElementById('selecao-avatar'); if (sel) sel.style.display = 'none';
    try { showToast('Avatar atualizado'); } catch(e){}
  } catch (e) { console.error('selecionarAvatar', e); }
};


/* Mapear bot√µes de curso / "Ir para Cursos" */
function bindCourseButtons(){
  try {
    var MAP = {
      empatia: 'modulo1.html',
      equipe: 'modulo2.html',
      emocional: 'modulo1.html',
      comunicacao: 'comunica√ß√£o.html'
    };
    // course buttons: ao clicar, rolar at√© se√ß√£o de cursos (se existir) ou abrir p√°gina
    var btns = Array.prototype.slice.call(document.querySelectorAll('.course-btn'));
    btns.forEach(function(btn){
      try {
        btn.removeEventListener('click', btn._handler);
      } catch(e){}
      btn._handler = function(){
        var course = btn.dataset && btn.dataset.course;
        var cursosAnchor = document.getElementById('cursos');
        if (cursosAnchor) {
          // rolar at√© a se√ß√£o de cursos (experi√™ncia integrada)
          cursosAnchor.scrollIntoView({ behavior:'smooth', block:'start' });
          // se quiser destacar o curso, n√£o h√° identifica√ß√£o por linha ‚Äî mantemos central behavior
        } else {
          var dest = MAP[course] || (course + '.html');
          window.location.href = dest;
        }
      };
      btn.addEventListener('click', btn._handler);
    });

    // bot√£o "Ir para os Cursos" (header)
    var goto = document.getElementById('gotoCourses');
    if (goto) {
      goto.removeEventListener('click', goto._handler);
      goto._handler = function() {
        var cursosAnchor = document.getElementById('cursos');
        if (cursosAnchor) cursosAnchor.scrollIntoView({ behavior:'smooth', block:'start' });
        else window.location.href = 'central.html#cursos';
      };
      goto.addEventListener('click', goto._handler);
    }
  } catch(e){ console.warn('bindCourseButtons', e); }
}
window.bindCourseButtons = bindCourseButtons;


/* Friends list (quem voc√™ segue) */
async function loadFriendsList(){
  try {
    var el = document.getElementById('friends');
    if (!el) return;
    el.innerHTML = 'Carregando...';
    if (!db) { el.innerHTML = '<div class="muted">Offline</div>'; return; }
    var meSnap = await db.collection('usuarios').where('nome','==',nomeUsuario).limit(1).get();
    if (meSnap.empty) { el.innerHTML = '<div>Nenhum amigo encontrado.</div>'; return; }
    var meData = meSnap.docs[0].data() || {};
    var following = Array.isArray(meData.following) ? meData.following : [];
    if (following.length === 0) { el.innerHTML = '<div>Voc√™ ainda n√£o segue ningu√©m.</div>'; return; }
    el.innerHTML = '';
    // carregar at√© 12 perfis seguidos
    var count = 0;
    for (var i = 0; i < following.length && count < 12; i++) {
      try {
        var name = following[i];
        var snaps = await db.collection('usuarios').where('nome','==',name).limit(1).get();
        if (snaps.empty) continue;
        var u = snaps.docs[0].data() || {};
        var id = snaps.docs[0].id;
        var row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.gap = '8px';
        row.style.padding = '6px 8px';
        row.style.border = '1px solid rgba(0,255,156,0.04)';
        row.style.borderRadius = '10px';
        row.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><img src="'+(u.avatar||defaultAvatar)+'" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #00ff9c"><div><div style="font-weight:700;color:#00ff9c">'+escapeHtml(u.nome)+'</div><div class="muted" style="font-size:12px">'+escapeHtml(u.tipo||'')+'</div></div></div><div style="display:flex;gap:8px"><button class="btn" onclick="openProfileModal(\''+escapeHtml(u.nome)+'\')">Perfil</button><button class="btn unfollowBtn" data-name="'+escapeHtml(u.nome)+'" data-id="'+id+'">Deixar de seguir</button></div>';
        el.appendChild(row);
        count++;
      } catch(e){ console.warn('loadFriendsList item', e); }
    }
    // attach unfollow handlers
    Array.prototype.slice.call(document.querySelectorAll('.unfollowBtn')).forEach(function(b){
      try { b.removeEventListener('click', b._handler); } catch(e){}
      b._handler = async function(e){
        var name = e.currentTarget.dataset.name;
        var id = e.currentTarget.dataset.id;
        await unfollowUser(name, id);
        loadFriendsList().catch(()=>{});
        loadUserSuggestions().catch(()=>{});
      };
      b.addEventListener('click', b._handler);
    });
  } catch(e){ console.error('loadFriendsList', e); }
}
window.loadFriendsList = loadFriendsList;


/* Leaderboard (top XP) */
async function loadLeaderboard(){
  try {
    var el = document.getElementById('leaderboard');
    if (!el) return;
    el.innerHTML = '<li>Carregando...</li>';
    if (!db) { el.innerHTML = '<li class="muted">Offline</li>'; return; }
    var snap = await db.collection('usuarios').orderBy('xp','desc').limit(10).get();
    el.innerHTML = '';
    if (!snap || snap.empty) { el.innerHTML = '<li>Nenhum usu√°rio</li>'; return; }
    snap.forEach(function(doc){
      var d = doc.data() || {};
      var li = document.createElement('li');
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.padding = '6px 8px';
      li.innerHTML = '<span><strong>'+escapeHtml(d.nome || '')+'</strong></span><span>'+(Number(d.xp||0))+' XP</span>';
      el.appendChild(li);
    });
  } catch(e){ console.error('loadLeaderboard', e); }
}
window.loadLeaderboard = loadLeaderboard;


/* Recent activity feed (atividades recentes) */
async function loadActivity(){
  try {
    const container = document.getElementById('activity-feed');
    if (!container) return;
    container.innerHTML = 'Carregando...';
    if (!db) { container.innerHTML = '<div class="muted">Offline</div>'; return; }

    function parseTimestampToDate(raw){
      if (!raw) return null;
      try {
        if (raw && typeof raw.toDate === 'function') return raw.toDate();
        if (raw && typeof raw.seconds === 'number') return new Date(raw.seconds * 1000);
        const d = new Date(raw);
        if (!isNaN(d)) return d;
      } catch(e){}
      return null;
    }

    let snap = await db.collection('activities').orderBy('createdAt','desc').limit(50).get().catch(()=>null);
    if (!snap || snap.empty) {
      snap = await db.collection('atividades').orderBy('createdAt','desc').limit(50).get().catch(()=>null) || snap;
    }

    container.innerHTML = '';
    if (!snap || snap.empty) { container.innerHTML = '<div class="small muted">Nenhuma atividade recente.</div>'; return; }

    // mostrar at√© 6 itens, sem op√ß√£o "Ver mais"
    const shownKeys = new Set();
    const MAX_SHOW = 6;
    let shown = 0;
    for (const doc of snap.docs) {
      if (shown >= MAX_SHOW) break;
      const d = doc.data() || {};
      const rawTs = d.createdAt || d.ts || d.time || d.date || null;
      const dateObj = parseTimestampToDate(rawTs) || new Date();
      const dateStr = dateObj.toLocaleDateString(); // apenas data, sem hora
      const text = (d.text || d.message || d.activity || '').trim() || 'Atividade';
      const key = (text + '|' + (dateObj.getTime())).slice(0,200);
      if (shownKeys.has(key)) continue;
      shownKeys.add(key);

      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.justifyContent = 'space-between';
      row.style.alignItems = 'flex-start';
      row.style.padding = '6px 8px';
      row.style.borderBottom = '1px solid rgba(0,255,156,0.02)';
      row.innerHTML = `<div style="font-size:13px;color:var(--muted);">${escapeHtml(text)}</div><div class="muted" style="font-size:12px;margin-left:8px">${escapeHtml(dateStr)}</div>`;
      container.appendChild(row);
      shown++;
    }

    if (shown === 0) {
      container.innerHTML = '<div class="small muted">Nenhuma atividade recente.</div>';
      return;
    }

    // removida op√ß√£o "Ver mais" conforme solicitado

  } catch(e){ console.error('loadActivity', e); }
}
window.loadActivity = loadActivity;


/* Legacy course scores / bottom table */
async function loadCourseScores(){
  try {
    var container = document.getElementById('course-scores-bottom');
    if (!container) return;
    container.innerHTML = 'Carregando...';
    if (!db) { container.innerHTML = '<div class="muted">Offline</div>'; return; }

    var KNOWN = {
      '√©tica':'√©tica',
      'comunicacao':'Comunica√ß√£o',
      'empatia':'Empatia',
      'equipe':'Trabalho em Equipe',
      'emocional':'Intelig√™ncia Emocional'
    };

    var snap = await db.collection('pontuacoes').get().catch(()=>null);
    var byCourse = {};
    if (snap && !snap.empty) {
      snap.forEach(function(doc){
        var d = doc.data() || {};
        var raw = String(d.curso || '').trim();
        if (!raw) return;
        var k = raw.toLowerCase();
        byCourse[k] = byCourse[k] || { nome: raw, best: 0, count: 0 };
        var pts = Number(d.pontuacao || 0);
        byCourse[k].count++;
        if (pts > byCourse[k].best) byCourse[k].best = pts;
      });
    }

    // ensure known courses present
    Object.keys(KNOWN).forEach(function(k){
      if (!byCourse[k]) byCourse[k] = { nome: KNOWN[k], best: 0, count: 0 };
      else byCourse[k].nome = KNOWN[k];
    });

    var keys = Object.keys(byCourse).sort(function(a,b){ return byCourse[b].best - byCourse[a].best; });

    // build table
    var table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.innerHTML = '<thead><tr><th style="text-align:left;padding:8px">Curso</th><th style="padding:8px">Melhor</th><th style="padding:8px">Entradas</th></tr></thead>';
    var tbody = document.createElement('tbody');
    keys.forEach(function(k){
      var c = byCourse[k];
      var tr = document.createElement('tr');
      tr.innerHTML = '<td style="padding:8px;text-align:left">'+escapeHtml(c.nome)+'</td><td style="padding:8px">'+(c.best||0)+'</td><td style="padding:8px">'+(c.count||0)+'</td>';
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.innerHTML = '';
    container.appendChild(table);
  } catch(e){ console.error('loadCourseScores', e); try { document.getElementById('course-scores-bottom') && (document.getElementById('course-scores-bottom').innerText = 'Erro ao carregar pontua√ß√µes.'); } catch(e){} }
}
window.loadCourseScores = loadCourseScores;


 /* Achievements button (abre modal e renderAchievements se existir) */
(function(){
  try {
    var ach = document.getElementById('openAchievements');
    if (!ach) return;
    ach.removeEventListener('click', ach._handler);
    ach._handler = function(){
      var m = document.getElementById('achievementsModal');
      if (!m) return;
      m.classList.toggle('hidden');
      if (!m.classList.contains('hidden') && typeof renderAchievements === 'function') {
        try { renderAchievements(); } catch(e){ console.warn(e); }
      }
    };
    ach.addEventListener('click', ach._handler);
  } catch(e){ console.warn('ach handler', e); }
})();

/* compat: alias para evitar ReferenceError (chamado em outros pontos) */
async function loadLegacyCourseScores() {
  if (typeof loadCourseScores === 'function') {
    return loadCourseScores();
  }
  return Promise.resolve();
}
window.loadLegacyCourseScores = loadLegacyCourseScores;

// iniciar aplica√ß√£o ap√≥s DOM e autentica√ß√£o
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const ok = await ensureLoggedInOrRedirect();
    if (!ok) return;
    // carrega app (tratamento de erro para n√£o travar)
    try { await initApp(); } catch(e){ console.error('initApp runtime error', e); }
  } catch (e) {
    console.error('startup error', e);
  }
});

  /* ANIMA√á√ÉO: neonCanvas (bolhas verdes) ‚Äî corrigido: sem <script> interno, loop robusto */
(function(){
  try {
    const canvas = document.getElementById('neonCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // style para n√£o interferir com a UI
    canvas.style.position = 'fixed';
    canvas.style.left = '0';
    canvas.style.top = '0';
    canvas.style.width = '100%';
    canvas.style.height = '100%';
    canvas.style.zIndex = '0';
    canvas.style.pointerEvents = 'none';

    let DPR = window.devicePixelRatio || 1;

    function resize() {
      DPR = window.devicePixelRatio || 1;
      const w = window.innerWidth;
      const h = window.innerHeight;
      canvas.width = Math.round(w * DPR);
      canvas.height = Math.round(h * DPR);
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }

    let bubbles = [];

    function initBubbles() {
      bubbles = [];
      const area = window.innerWidth * window.innerHeight;
      const count = Math.min(60, Math.max(8, Math.floor(area / 90000)));
      for (let i = 0; i < count; i++) {
        const r = 8 + Math.random() * 48;
        bubbles.push({
          x: Math.random() * window.innerWidth,
          y: window.innerHeight + Math.random() * window.innerHeight * 0.6,
          r: r,
          vy: 0.2 + Math.random() * 0.8,
          vx: (Math.random() - 0.5) * 0.6,
          alpha: 0.04 + Math.random() * 0.18,
          hue: 150 + Math.random() * 40
        });
      }
    }

    function drawFrame() {
      ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
      for (let i = 0; i < bubbles.length; i++) {
        const b = bubbles[i];
        b.y -= b.vy;
        b.x += b.vx;
        if (b.y < -b.r * 2) {
          b.x = Math.random() * window.innerWidth;
          b.y = window.innerHeight + b.r;
        }
        const g = ctx.createRadialGradient(b.x, b.y, Math.max(1, b.r * 0.1), b.x, b.y, b.r * 1.8);
        g.addColorStop(0, `rgba(0,255,156,${Math.min(0.7, b.alpha * 1.6)})`);
        g.addColorStop(0.35, `rgba(0,200,140,${b.alpha})`);
        g.addColorStop(1, `rgba(0,40,30,0)`);
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function loop() {
      drawFrame();
      requestAnimationFrame(loop);
    }

    resize();
    initBubbles();
    window.addEventListener('resize', () => {
      try { resize(); initBubbles(); } catch(e){ console.warn(e); }
    });

    requestAnimationFrame(loop);
  } catch (err) {
    console.warn('neonCanvas init error', err);
  }
})(); 
</script>

</body></html>