<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>COMUNICAÇÃO</title>

  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --neon-green: #00ff9c;
      --neon-blue: #00b4ff;
      --neon-purple: #6c07ab;
      --dark-bg: #0a0a14;
      --darker-bg: #050510;
    }

    * {
      box-sizing: border-box;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 10px var(--neon-green), 0 0 20px rgba(0, 255, 156, 0.3);
      }
      50% {
        box-shadow: 0 0 20px var(--neon-green), 0 0 40px rgba(0, 255, 156, 0.5);
      }
    }

    @keyframes scanline {
      0% {
        background-position: 0 -100vh;
      }
      100% {
        background-position: 0 100vh;
      }
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    body {
      margin: 0;
      background: var(--darker-bg);
      color: var(--neon-green);
      font-family: 'Orbitron', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(
          rgba(0, 255, 156, 0.05) 1px, 
          transparent 1px
        ),
        linear-gradient(
          90deg,
          rgba(0, 255, 156, 0.05) 1px, 
          transparent 1px
        );
      background-size: 20px 20px;
      pointer-events: none;
      z-index: -1;
    }

    body::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        to bottom,
        transparent 95%,
        rgba(0, 255, 156, 0.1) 100%
      );
      animation: scanline 6s linear infinite;
      pointer-events: none;
      z-index: -1;
    }


    .container {
      max-width: 800px;
      width: 100%;
      border: 2px solid var(--neon-green);
      border-radius: 12px;
      box-shadow: 0 0 20px var(--neon-green);
      padding: 30px;
      background-color: rgba(10, 10, 20, 0.9);
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s ease;
    }

    h1, h2 {
      font-family: 'Orbitron', sans-serif;
      color: var(--neon-green);
      margin-top: 0;
      font-weight: 700;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 30px;
      letter-spacing: 2px;
    }

    h2 {
      font-size: 1.8rem;
      margin-bottom: 20px;
    }

    .button {
      margin: 15px;
      padding: 15px 35px;
      font-size: 1.1rem;
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
      background: transparent;
      border: 2px solid var(--neon-green);
      color: var(--neon-green);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      letter-spacing: 1px;
    }

    .button:hover {
      background: var(--neon-green);
      color: var(--darker-bg);
      box-shadow: 0 0 20px var(--neon-green);
    }

    .hidden {
      display: none;
    }

    .text-display {
      font-size: 1.5rem;
      margin: 30px 0;
      line-height: 1.8;
      min-height: 120px;
      padding: 20px;
      background: rgba(0, 20, 30, 0.5);
      border: 1px solid var(--neon-blue);
      border-radius: 8px;
      animation: float 4s ease-in-out infinite;
    }

    .input-area {
      width: 100%;
      padding: 18px;
      font-size: 1.3rem;
      font-family: 'Orbitron', sans-serif;
      border: 2px solid var(--neon-purple);
      border-radius: 8px;
      background: rgba(10, 5, 20, 0.7);
      color: var(--neon-green);
      margin: 20px 0;
      transition: all 0.3s ease;
    }

    .input-area:focus {
      outline: none;
      border-color: var(--neon-green);
      box-shadow: 0 0 15px var(--neon-green);
    }

    .stats {
      margin: 25px 0;
      font-size: 1.2rem;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .stats span {
      padding: 8px 15px;
      background: rgba(0, 180, 255, 0.2);
      border-radius: 5px;
      border: 1px solid var(--neon-blue);
    }

    .cronometro {
      margin: 25px 0;
      height: 25px;
      width: 100%;
      background: rgba(0, 20, 30, 0.7);
      border: 2px solid var(--neon-blue);
      border-radius: 15px;
      overflow: hidden;
    }

    .cronometro-barra {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-blue), var(--neon-green));
      width: 100%;
      transition: width 1s linear;
    }

    .feedback {
      margin: 25px 0;
      font-size: 1.3rem;
      font-weight: bold;
      min-height: 30px;
    }

    .player-list {
      text-align: center;
      margin: 25px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }

    .player-list h3 {
      width: 100%;
      margin-bottom: 15px;
    }

    .player-list div {
      padding: 10px 20px;
      background: rgba(157, 0, 255, 0.1);
      border: 1px solid var(--neon-purple);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .player-list img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--neon-green);
      object-fit: cover;
    }

    #resultadoFinal {
      color: var(--neon-green);
      text-align: center;
      padding: 40px;
      background: rgba(5, 5, 20, 0.95);
    }

    #ranking {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 30px 0;
    }

    #ranking div {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      font-size: 1.3rem;
      color: white;
      background: rgba(0, 255, 200, 0.1);
      border: 1px solid var(--neon-green);
      border-radius: 10px;
      padding: 15px;
    }

    #ranking img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid var(--neon-green);
    }

    /* Responsividade */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      .container {
        padding: 20px;
      }
      
      .button {
        padding: 12px 25px;
        font-size: 1rem;
      }
      
      .text-display {
        font-size: 1.2rem;
        padding: 15px;
      }
      
      .input-area {
        font-size: 1.1rem;
        padding: 15px;
      }
    }

    .btn-exit {
      position: absolute;
      top: 18px;
      right: 18px;
      background: transparent;
      border: none;
      color: var(--neon-green);
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
      transition: color 0.2s;
    }
    .btn-exit:hover {
      color: var(--neon-blue);
    }
  </style>
</head>
<body>

<!-- MENU -->
<div class="container" id="menu">
  <button class="button btn-exit" onclick="voltarCentral()" title="Sair para Central">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;">
      <path d="M16 17l5-5m0 0l-5-5m5 5H9m4 9a9 9 0 1 1 0-18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  <h1>COMUNICAÇÃO</h1>
  <button class="button" onclick="criarSala()">CRIAR SALA</button>
  <button class="button" onclick="mostrarEntrada()">ENTRAR EM SALA</button>
  <div id="entradaSala" class="hidden">
    <input id="codigoSala" placeholder="CÓDIGO DA SALA..." class="input-area" />
    <button class="button" onclick="entrarEmSala()">ENTRAR</button>
  </div>
</div>

<!-- SALA -->
<div class="container hidden" id="sala">
  <button class="button btn-exit" onclick="voltarCentral()" title="Sair para Central">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;">
      <path d="M16 17l5-5m0 0l-5-5m5 5H9m4 9a9 9 0 1 1 0-18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  <h2>SALA: <span id="salaIdTexto">...</span></h2>
  <div class="stats">VOCÊ É: <strong><span id="nomeJogador">...</span></strong></div>
  <div class="player-list" id="jogadoresLista"></div>
  <button class="button hidden" id="comecarJogoBtn" onclick="iniciarJogo()">COMEÇAR JOGO</button>
  <button class="button" onclick="voltarMenu()">VOLTAR AO MENU</button>
</div>

<!-- JOGO -->
<div class="container hidden" id="jogo">
  <button class="button btn-exit" onclick="voltarCentral()" title="Sair para Central">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;">
      <path d="M16 17l5-5m0 0l-5-5m5 5H9m4 9a9 9 0 1 1 0-18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  <h2>SALA: <span id="salaIdTexto2">...</span></h2>
  <div class="stats">
    <span>RODADA: <span id="rodada">1</span>/5</span>
    <span>PONTUAÇÃO: <span id="pontuacao">0</span></span>
  </div>
  <div class="text-display" id="fraseDisplay"></div>
  <div class="cronometro"><div class="cronometro-barra" id="barraTempo"></div></div>
  <input type="text" class="input-area" id="entrada" placeholder="DIGITE AQUI..." disabled autocomplete="off" />
  <div class="feedback" id="feedback"></div>
  <button class="button" onclick="voltarMenu()">VOLTAR AO MENU</button>
</div>

<!-- RESULTADO -->
<div id="resultadoFinal" class="container hidden">
  <button class="button btn-exit" onclick="voltarCentral()" title="Sair para Central">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;">
      <path d="M16 17l5-5m0 0l-5-5m5 5H9m4 9a9 9 0 1 1 0-18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  <h2>🏁 RESULTADO FINAL 🏁</h2>
  <div id="ranking"></div>
  <button class="button" onclick="voltarAoMenu()">VOLTAR AO MENU</button>
</div>

<!-- Sons -->
<audio id="somAcerto" src="https://cdn.pixabay.com/audio/2022/03/15/audio_40523e415c.mp3"></audio>
<audio id="somErro" src="https://cdn.pixabay.com/audio/2022/03/02/audio_59ff3cd7e2.mp3"></audio>
<audio id="somFim" src="https://cdn.pixabay.com/audio/2022/10/24/audio_65e4f7d3f0.mp3"></audio>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAVZ-dvyJuGFF4fEHGjS-TrhzBmBslVwNs",
    authDomain: "curso-3-inteligencia-emocional.firebaseapp.com",
    projectId: "curso-3-inteligencia-emocional",
    storageBucket: "curso-3-inteligencia-emocional.appspot.com"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const nomeUsuario = localStorage.getItem("usuario") || "Jogador";
  const avatarUsuario = localStorage.getItem("avatar") || "img/img1.png";

  // registra acesso (silencioso)
  db.collection("usuarios").where("nome", "==", nomeUsuario).limit(1).get().then(() => {}).catch(()=>{});

  // registro rápido de participação (não crítico)
  db.collection("pontuacoes").add({ usuario: nomeUsuario, curso: "Comunicação", avatar: avatarUsuario, ts: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});

  let salaRef = null, salaId = null;
  let host = false, jogadorId = nomeUsuario, jogadores = [];
  let fraseAtual = "", rodadaAtual = 0, maxRodadas = 5;
  let pontuacao = 0;
  let tempoMaximo = 30, tempoRestante = tempoMaximo, cronometroInterval = null;
  const somAcerto = document.getElementById("somAcerto");
  const somErro = document.getElementById("somErro");
  const somFim = document.getElementById("somFim");

  function criarSala() {
    salaId = "SALA-" + Math.floor(Math.random() * 10000);
    host = true;
    salaRef = db.collection("salas").doc(salaId);
    const salaObj = {
      jogadores: [{ nome: jogadorId, avatar: avatarUsuario, pontos: 0 }],
      host: jogadorId,
      status: "ESPERANDO",
      rodada: 0,
      frase: "",
      frasesUsadas: [],
      respondidoPor: []
    };
    salaRef.set(salaObj).then(() => iniciarSala()).catch(err => alert("Erro ao criar sala: "+err));
  }

  function mostrarEntrada() {
    document.getElementById("entradaSala").classList.remove("hidden");
  }

  async function entrarEmSala() {
    const codigo = document.getElementById("codigoSala").value.trim().toUpperCase();
    if (!codigo) return alert("DIGITE O CÓDIGO DA SALA");
    salaId = codigo;
    salaRef = db.collection("salas").doc(salaId);
    const doc = await salaRef.get();
    if (!doc.exists) return alert("SALA NÃO ENCONTRADA");
    await salaRef.update({
      jogadores: firebase.firestore.FieldValue.arrayUnion({ nome: jogadorId, avatar: avatarUsuario, pontos: 0 })
    });
    host = false;
    iniciarSala();
  }

  function iniciarSala() {
    document.getElementById("menu").classList.add("hidden");
    document.getElementById("sala").classList.remove("hidden");
    document.getElementById("salaIdTexto").textContent = salaId;
    document.getElementById("nomeJogador").textContent = jogadorId;

    salaRef.onSnapshot(doc => {
      if (!doc.exists) return;
      const data = doc.data();
      jogadores = data.jogadores || [];
      document.getElementById("jogadoresLista").innerHTML = "<h3>JOGADORES:</h3>" + jogadores.map(j => `
        <div><img src="${j.avatar}" /><span>${j.nome} (${j.pontos||0})</span></div>
      `).join("");

      // mostrar botão iniciar só para host e se houver jogador a mais
      if (data.host === jogadorId) {
        host = true;
        if (jogadores.length > 0 && data.status === "ESPERANDO") {
          document.getElementById("comecarJogoBtn").classList.remove("hidden");
        } else {
          document.getElementById("comecarJogoBtn").classList.add("hidden");
        }
      } else {
        host = false;
        document.getElementById("comecarJogoBtn").classList.add("hidden");
      }

      // quando status muda para JOGANDO mostra o jogo
      if (data.status === "JOGANDO") {
        document.getElementById("sala").classList.add("hidden");
        document.getElementById("jogo").classList.remove("hidden");
        document.getElementById("salaIdTexto2").textContent = salaId;
        iniciarRodada(data.frase, data.rodada, data.respondidoPor || [], data.jogadores || []);
      }

      if (data.status === "FINALIZADO") {
        document.getElementById("jogo").classList.add("hidden");
        mostrarResultadoFinal(data.jogadores || []);
      }
    });
  }

  async function iniciarJogo() {
    // apenas host inicia
    if (!salaRef) return alert("Sala inválida");
    const doc = await salaRef.get();
    if (!doc.exists) return alert("Sala inexistente");
    // escolhe frase inicial e seta status JOGANDO
    const frasesAll = [
      "A COMUNICAÇÃO EFICAZ É A BASE DE QUALQUER RELAÇÃO BEM-SUCEDIDA.",
      "FALAR É UMA NECESSIDADE, ESCUTAR É UMA ARTE.",
      "PALAVRAS SÃO PODEROSAS, USE-AS COM SABEDORIA.",
      "A CLAREZA NA FALA EVITA RUÍDOS NA ESCUTA.",
      "EMPATIA É ENTENDER ANTES DE RESPONDER.",
      "O SILÊNCIO TAMBÉM COMUNICA.",
      "BOAS CONVERSAS GERAM GRANDES IDEIAS.",
      "CONEXÕES VERDADEIRAS NASCEM DE PALAVRAS SINCERAS.",
      "A VOZ CALMA ACALMA ATÉ O CAOS.",
      "SER OUVIDO É TÃO IMPORTANTE QUANTO SER ENTENDIDO."
    ];
    const frase = frasesAll[Math.floor(Math.random()*frasesAll.length)];
    await salaRef.update({
      status: "JOGANDO",
      rodada: 1,
      frase,
      frasesUsadas: firebase.firestore.FieldValue.arrayUnion(frase),
      respondidoPor: []
    });
  }

  // prevenção copiar/colar
  document.getElementById("entrada").addEventListener("paste", e => e.preventDefault());
  document.getElementById("entrada").addEventListener("copy", e => e.preventDefault());

  // controle local para impedir múltiplos acertos do mesmo jogador na mesma rodada
  let jáPontuouNaRodada = false;

  async function iniciarRodada(frase, rodada, respondidoPorArr = [], jogadoresArr = []) {
    clearInterval(cronometroInterval);
    document.getElementById("entrada").value = "";
    document.getElementById("fraseDisplay").textContent = frase || "";
    document.getElementById("rodada").textContent = rodada || 1;
    document.getElementById("pontuacao").textContent = pontuacao;
    document.getElementById("feedback").textContent = "";
    fraseAtual = frase || "";
    rodadaAtual = rodada || 1;
    jáPontuouNaRodada = (respondidoPorArr || []).includes(jogadorId);

    // atualiza jogadores locais se fornecido
    if (Array.isArray(jogadoresArr) && jogadoresArr.length) jogadores = jogadoresArr;

    // se todos já responderam -> bloqueia e exibe mensagem; host tenta avançar automaticamente
    if (Array.isArray(respondidoPorArr) && jogadores.length && respondidoPorArr.length >= jogadores.length) {
      document.getElementById("entrada").disabled = true;
      document.getElementById("feedback").textContent = "Aguardando próxima rodada...";
      document.getElementById("feedback").style.color = "yellow";
      clearInterval(cronometroInterval);
      // host tenta avançar; se host ausente, qualquer cliente pode forçar (ver requestAdvance)
      if (host) requestAdvance(false).catch(()=>{});
      return;
    }

    // se o jogador já respondeu, bloqueia entrada e aguarda
    if (jáPontuouNaRodada) {
      document.getElementById("entrada").disabled = true;
      document.getElementById("feedback").textContent = "Aguardando os demais jogadores...";
      document.getElementById("feedback").style.color = "yellow";
      // ainda inicializa o cronômetro visual para acompanhar a rodada
    } else {
      document.getElementById("entrada").disabled = false;
      document.getElementById("entrada").focus();
    }

    tempoRestante = tempoMaximo;
    atualizarBarraTempo();
    cronometroInterval = setInterval(() => {
      tempoRestante--;
      atualizarBarraTempo();
      if (tempoRestante <= 0) {
        clearInterval(cronometroInterval);
        onTempoEsgotado();
      }
    }, 1000);
  }

  function atualizarBarraTempo() {
    const pct = Math.max(0, (tempoRestante / tempoMaximo) * 100);
    const barra = document.getElementById("barraTempo");
    barra.style.width = pct + "%";
    if (pct > 50) barra.style.background = "linear-gradient(90deg, var(--neon-blue), var(--neon-green))";
    else if (pct > 20) barra.style.background = "linear-gradient(90deg, var(--neon-green), yellow)";
    else barra.style.background = "linear-gradient(90deg, yellow, red)";
  }

  async function onTempoEsgotado() {
    document.getElementById("entrada").disabled = true;
    document.getElementById("feedback").textContent = "⏰ TEMPO ESGOTADO!";
    document.getElementById("feedback").style.color = "red";
    somErro.play();
    // força avanço de rodada (qualquer cliente tenta; transação protege)
    requestAdvance(true).catch(()=>{});
  }

  document.getElementById("entrada").addEventListener("input", async () => {
    if (!fraseAtual || jáPontuouNaRodada) return;
    const texto = document.getElementById("entrada").value.toUpperCase().trim();
    if (!texto) return;
    if (texto === fraseAtual) {
      // acertou
      jáPontuouNaRodada = true;
      clearInterval(cronometroInterval);
      const tempoGasto = Math.max(1, tempoMaximo - tempoRestante);
      const wpm = Math.round((fraseAtual.split(" ").length / tempoGasto) * 60);
      const pontosGanhos = Math.max(100 - tempoGasto * 2, 10) + wpm;
      pontuacao += pontosGanhos;
      document.getElementById("pontuacao").textContent = pontuacao;
      document.getElementById("feedback").textContent = `✅ +${pontosGanhos} PONTOS | WPM: ${wpm}`;
      document.getElementById("feedback").style.color = "var(--neon-green)";
      document.getElementById("entrada").disabled = true;
      somAcerto.play();

      // atualiza pontos e respondidoPor no documento de sala usando transação
      try {
        await db.runTransaction(async (tx) => {
          const snap = await tx.get(salaRef);
          if (!snap.exists) return;
          const data = snap.data();
          const jogadoresDoc = (data.jogadores || []).map(j => {
            if (j.nome === jogadorId) {
              return { ...j, pontos: ( (j.pontos||0) + pontosGanhos ) };
            }
            return j;
          });
          tx.update(salaRef, {
            jogadores: jogadoresDoc,
            respondidoPor: firebase.firestore.FieldValue.arrayUnion(jogadorId)
          });
        });
        // solicitar avanço (se condição atendida transação de avanço fará a mudança)
        requestAdvance(false).catch(()=>{});
      } catch (e) {
        console.error("Erro ao atualizar pontos:", e);
      }
    }
  });

 
  async function requestAdvance(force = false) {
    if (!salaRef) return;
    try {
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(salaRef);
        if (!snap.exists) return;
        const data = snap.data();
        if (data.status !== "JOGANDO") return;
        const jogadoresDoc = data.jogadores || [];
        const respondidoPor = data.respondidoPor || [];
        const totalPlayers = jogadoresDoc.length || 0;

        // condição de avanço: todos responderam ou force = true
        if (!force && respondidoPor.length < totalPlayers) return;

        // se ainda há rodadas
        const rodadaAtualLocal = data.rodada || 1;
        if (rodadaAtualLocal >= maxRodadas) {
          // finalizar: atualiza status e mantém jogadores com pontos finais
          tx.update(salaRef, { status: "FINALIZADO" });
        } else {
          // escolher nova frase que não esteja em frasesUsadas
          const todas = [
            "A COMUNICAÇÃO EFICAZ É A BASE DE QUALQUER RELAÇÃO BEM-SUCEDIDA.",
            "FALAR É UMA NECESSIDADE, ESCUTAR É UMA ARTE.",
            "PALAVRAS SÃO PODEROSAS, USE-AS COM SABEDORIA.",
            "A CLAREZA NA FALA EVITA RUÍDOS NA ESCUTA.",
            "EMPATIA É ENTENDER ANTES DE RESPONDER.",
            "O SILÊNCIO TAMBÉM COMUNICA.",
            "BOAS CONVERSAS GERAM GRANDES IDEIAS.",
            "CONEXÕES VERDADEIRAS NASCEM DE PALAVRAS SINCERAS.",
            "A VOZ CALMA ACALMA ATÉ O CAOS.",
            "SER OUVIDO É TÃO IMPORTANTE QUANTO SER ENTENDIDO."
          ];
          const usadas = data.frasesUsadas || [];
          const disponiveis = todas.filter(f => !usadas.includes(f));
          const proxima = (disponiveis.length ? disponiveis : todas)[Math.floor(Math.random()* (disponiveis.length ? disponiveis.length : todas.length))];
          // reset respondidoPor e incrementa rodada e adiciona frase em frasesUsadas
          tx.update(salaRef, {
            rodada: rodadaAtualLocal + 1,
            frase: proxima,
            frasesUsadas: firebase.firestore.FieldValue.arrayUnion(proxima),
            respondidoPor: []
          });
        }
      });
    } catch (e) {
      console.error("Erro na transação de avanço:", e);
    }
  }

  // função utilitária: concede XP ao usuário por curso (transação simples, idempotente)
  async function giveXPForCourse(courseKey, score) {
    try {
      const nome = localStorage.getItem('usuario') || 'desconhecido';
      const q = await db.collection('usuarios').where('nome','==',nome).limit(1).get();
      let userRef;
      if (q.empty) {
        const ref = await db.collection('usuarios').add({
          nome,
          avatar: localStorage.getItem('avatar') || avatarUsuario,
          xp: 0,
          processedCourses: [],
          badges: []
        });
        userRef = ref;
      } else {
        userRef = q.docs[0].ref;
      }

      await db.runTransaction(async (tx) => {
        const snap = await tx.get(userRef);
        if (!snap.exists) return;
        const data = snap.data() || {};
        const processed = Array.isArray(data.processedCourses) ? data.processedCourses : [];
        if (processed.includes(courseKey)) return; // já processado
        const xpGain = Math.max(5, Math.round(Number(score || 0) / 10)); // simples: score/10
        tx.update(userRef, {
          xp: (Number(data.xp || 0) + xpGain),
          processedCourses: firebase.firestore.FieldValue.arrayUnion(courseKey),
          xpHistory: firebase.firestore.FieldValue.arrayUnion({ ts: firebase.firestore.Timestamp.now(), xp: xpGain, course: courseKey, score: Number(score||0) })
        });
      });

      // feedback local
      showToast(`+${Math.max(5, Math.round(Number(score || 0)/10))} XP recebido por ${courseKey}`);
      // opcional: atualizar leaderboard/profile se estiver na central
      try { if (typeof renderUserProfile === 'function') renderUserProfile(); } catch(e){}
      try { if (typeof loadLeaderboard === 'function') loadLeaderboard(); } catch(e){}
    } catch (e) {
      console.error('giveXPForCourse error', e);
    }
  }

  function mostrarResultadoFinal(jogadoresPontuacao) {
    const resultadoDiv = document.getElementById("resultadoFinal");
    const rankingDiv = document.getElementById("ranking");
    const ordenado = [...jogadoresPontuacao].sort((a,b) => (b.pontos||0)-(a.pontos||0));
    rankingDiv.innerHTML = ordenado.map((j,i) => `
      <div><strong>#${i+1}</strong><img src="${j.avatar}" alt="av"><span>${j.nome} - ${j.pontos||0} PTS</span></div>
    `).join("");
    resultadoDiv.classList.remove("hidden");
    somFim.play();

    // identifica minha pontuação e concede XP direto no Firestore (idempotente)
    try {
      const meuScore = (ordenado.find(j => j.nome === jogadorId) || {}).pontos || 0;
      giveXPForCourse('comunicacao', Number(meuScore)).catch(e => console.warn('XP assign failed', e));
    } catch(e){
      console.warn('failed to compute/confer my score', e);
    }

    // limpar flags locais antigas (compatibilidade)
    try { localStorage.removeItem('score_comunicacao'); localStorage.removeItem('courseComplete::comunicacao'); } catch(e){}
  }

  function voltarMenu() { location.reload(); }
  function voltarAoMenu() { location.reload(); }
  function voltarCentral() { window.location.href = "central.html"; }
</script>

</body>
</html>